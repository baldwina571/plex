<html>
<head>
<title>_inputstream.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #b877db; font-style: italic;}
.s1 { color: #b6c4f2;}
.s2 { color: #b4c2f0;}
.s3 { color: #475f76;}
.s4 { color: #baacff;}
.s5 { color: #7fdaff;}
.s6 { color: #64d1a9;}
.s7 { color: #ff9668;}
</style>
</head>
<body bgcolor="#1c1e26">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_inputstream.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span><span class="s2">, </span><span class="s1">division</span><span class="s2">, </span><span class="s1">unicode_literals</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">six </span><span class="s0">import </span><span class="s1">text_type</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">six</span><span class="s2">.</span><span class="s1">moves </span><span class="s0">import </span><span class="s1">http_client</span><span class="s2">, </span><span class="s1">urllib</span>

<span class="s0">import </span><span class="s1">codecs</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span><span class="s2">, </span><span class="s1">StringIO</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor </span><span class="s0">import </span><span class="s1">webencodings</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">constants </span><span class="s0">import </span><span class="s1">EOF</span><span class="s2">, </span><span class="s1">spaceCharacters</span><span class="s2">, </span><span class="s1">asciiLetters</span><span class="s2">, </span><span class="s1">asciiUppercase</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">constants </span><span class="s0">import </span><span class="s1">_ReparseException</span>
<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">_utils</span>

<span class="s3"># Non-unicode versions of constants for use in the pre-parser</span>
<span class="s1">spaceCharactersBytes </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s5">[</span><span class="s1">item</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s6">&quot;ascii&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">spaceCharacters</span><span class="s5">]</span><span class="s2">)</span>
<span class="s1">asciiLettersBytes </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s5">[</span><span class="s1">item</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s6">&quot;ascii&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">asciiLetters</span><span class="s5">]</span><span class="s2">)</span>
<span class="s1">asciiUppercaseBytes </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s5">[</span><span class="s1">item</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s6">&quot;ascii&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">asciiUppercase</span><span class="s5">]</span><span class="s2">)</span>
<span class="s1">spacesAngleBrackets </span><span class="s4">= </span><span class="s1">spaceCharactersBytes </span><span class="s4">| </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s5">[</span><span class="s6">b&quot;&gt;&quot;</span><span class="s2">, </span><span class="s6">b&quot;&lt;&quot;</span><span class="s5">]</span><span class="s2">)</span>


<span class="s1">invalid_unicode_no_surrogate </span><span class="s4">= </span><span class="s6">&quot;[\u0001-\u0008\u000B\u000E-\u001F\u007F-\u009F\uFDD0-\uFDEF\uFFFE\uFFFF\U0001FFFE\U0001FFFF\U0002FFFE\U0002FFFF\U0003FFFE\U0003FFFF\U0004FFFE\U0004FFFF\U0005FFFE\U0005FFFF\U0006FFFE\U0006FFFF\U0007FFFE\U0007FFFF\U0008FFFE\U0008FFFF\U0009FFFE\U0009FFFF\U000AFFFE\U000AFFFF\U000BFFFE\U000BFFFF\U000CFFFE\U000CFFFF\U000DFFFE\U000DFFFF\U000EFFFE\U000EFFFF\U000FFFFE\U000FFFFF\U0010FFFE\U0010FFFF]&quot;  </span><span class="s3"># noqa</span>

<span class="s0">if </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">supports_lone_surrogates</span><span class="s4">:</span>
    <span class="s3"># Use one extra step of indirection and create surrogates with</span>
    <span class="s3"># eval. Not using this indirection would introduce an illegal</span>
    <span class="s3"># unicode literal on platforms not supporting such lone</span>
    <span class="s3"># surrogates.</span>
    <span class="s0">assert </span><span class="s1">invalid_unicode_no_surrogate</span><span class="s5">[</span><span class="s4">-</span><span class="s7">1</span><span class="s5">] </span><span class="s4">== </span><span class="s6">&quot;]&quot; </span><span class="s0">and </span><span class="s1">invalid_unicode_no_surrogate</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s6">&quot;]&quot;</span><span class="s2">) </span><span class="s4">== </span><span class="s7">1</span>
    <span class="s1">invalid_unicode_re </span><span class="s4">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">invalid_unicode_no_surrogate</span><span class="s5">[</span><span class="s4">:-</span><span class="s7">1</span><span class="s5">] </span><span class="s4">+</span>
                                    <span class="s1">eval</span><span class="s2">(</span><span class="s6">'&quot;\\uD800-\\uDFFF&quot;'</span><span class="s2">) </span><span class="s4">+  </span><span class="s3"># pylint:disable=eval-used</span>
                                    <span class="s6">&quot;]&quot;</span><span class="s2">)</span>
<span class="s0">else</span><span class="s4">:</span>
    <span class="s1">invalid_unicode_re </span><span class="s4">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">invalid_unicode_no_surrogate</span><span class="s2">)</span>

<span class="s1">non_bmp_invalid_codepoints </span><span class="s4">= </span><span class="s5">{</span><span class="s7">0x1FFFE</span><span class="s2">, </span><span class="s7">0x1FFFF</span><span class="s2">, </span><span class="s7">0x2FFFE</span><span class="s2">, </span><span class="s7">0x2FFFF</span><span class="s2">, </span><span class="s7">0x3FFFE</span><span class="s2">,</span>
                              <span class="s7">0x3FFFF</span><span class="s2">, </span><span class="s7">0x4FFFE</span><span class="s2">, </span><span class="s7">0x4FFFF</span><span class="s2">, </span><span class="s7">0x5FFFE</span><span class="s2">, </span><span class="s7">0x5FFFF</span><span class="s2">,</span>
                              <span class="s7">0x6FFFE</span><span class="s2">, </span><span class="s7">0x6FFFF</span><span class="s2">, </span><span class="s7">0x7FFFE</span><span class="s2">, </span><span class="s7">0x7FFFF</span><span class="s2">, </span><span class="s7">0x8FFFE</span><span class="s2">,</span>
                              <span class="s7">0x8FFFF</span><span class="s2">, </span><span class="s7">0x9FFFE</span><span class="s2">, </span><span class="s7">0x9FFFF</span><span class="s2">, </span><span class="s7">0xAFFFE</span><span class="s2">, </span><span class="s7">0xAFFFF</span><span class="s2">,</span>
                              <span class="s7">0xBFFFE</span><span class="s2">, </span><span class="s7">0xBFFFF</span><span class="s2">, </span><span class="s7">0xCFFFE</span><span class="s2">, </span><span class="s7">0xCFFFF</span><span class="s2">, </span><span class="s7">0xDFFFE</span><span class="s2">,</span>
                              <span class="s7">0xDFFFF</span><span class="s2">, </span><span class="s7">0xEFFFE</span><span class="s2">, </span><span class="s7">0xEFFFF</span><span class="s2">, </span><span class="s7">0xFFFFE</span><span class="s2">, </span><span class="s7">0xFFFFF</span><span class="s2">,</span>
                              <span class="s7">0x10FFFE</span><span class="s2">, </span><span class="s7">0x10FFFF</span><span class="s5">}</span>

<span class="s1">ascii_punctuation_re </span><span class="s4">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s6">&quot;[\u0009-\u000D\u0020-\u002F\u003A-\u0040\u005C\u005B-\u0060\u007B-\u007E]&quot;</span><span class="s2">)</span>

<span class="s3"># Cache for charsUntil()</span>
<span class="s1">charsUntilRegEx </span><span class="s4">= </span><span class="s5">{}</span>


<span class="s0">class </span><span class="s1">BufferedStream</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s3">&quot;&quot;&quot;Buffering for streams that do not have buffering of their own 
 
    The buffer is implemented as a list of chunks on the assumption that 
    joining many strings will be slow since it is O(n**2) 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stream </span><span class="s4">= </span><span class="s1">stream</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">buffer </span><span class="s4">= </span><span class="s5">[]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s4">= </span><span class="s5">[</span><span class="s4">-</span><span class="s7">1</span><span class="s2">, </span><span class="s7">0</span><span class="s5">]  </span><span class="s3"># chunk number, offset</span>

    <span class="s0">def </span><span class="s1">tell</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">pos </span><span class="s4">= </span><span class="s7">0</span>
        <span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s5">[</span><span class="s4">:</span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]]</span><span class="s4">:</span>
            <span class="s1">pos </span><span class="s4">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">)</span>
        <span class="s1">pos </span><span class="s4">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">1</span><span class="s5">]</span>
        <span class="s0">return </span><span class="s1">pos</span>

    <span class="s0">def </span><span class="s1">seek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">assert </span><span class="s1">pos </span><span class="s4">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bufferedBytes</span><span class="s2">()</span>
        <span class="s1">offset </span><span class="s4">= </span><span class="s1">pos</span>
        <span class="s1">i </span><span class="s4">= </span><span class="s7">0</span>
        <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s5">[</span><span class="s1">i</span><span class="s5">]</span><span class="s2">) </span><span class="s4">&lt; </span><span class="s1">offset</span><span class="s4">:</span>
            <span class="s1">offset </span><span class="s4">-= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s5">[</span><span class="s1">i</span><span class="s5">]</span><span class="s2">)</span>
            <span class="s1">i </span><span class="s4">+= </span><span class="s7">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s4">= </span><span class="s5">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">offset</span><span class="s5">]</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_readStream</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s4">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s2">) </span><span class="s0">and</span>
              <span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">1</span><span class="s5">] </span><span class="s4">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s5">[</span><span class="s4">-</span><span class="s7">1</span><span class="s5">]</span><span class="s2">))</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_readStream</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_readFromBuffer</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_bufferedBytes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s5">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">item</span><span class="s2">) </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s5">]</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_readStream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s4">+= </span><span class="s7">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">1</span><span class="s5">] </span><span class="s4">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">_readFromBuffer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">remainingBytes </span><span class="s4">= </span><span class="s1">bytes</span>
        <span class="s1">rv </span><span class="s4">= </span><span class="s5">[]</span>
        <span class="s1">bufferIndex </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s1">bufferOffset </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s5">[</span><span class="s7">1</span><span class="s5">]</span>
        <span class="s0">while </span><span class="s1">bufferIndex </span><span class="s4">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s2">) </span><span class="s0">and </span><span class="s1">remainingBytes </span><span class="s4">!= </span><span class="s7">0</span><span class="s4">:</span>
            <span class="s0">assert </span><span class="s1">remainingBytes </span><span class="s4">&gt; </span><span class="s7">0</span>
            <span class="s1">bufferedData </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buffer</span><span class="s5">[</span><span class="s1">bufferIndex</span><span class="s5">]</span>

            <span class="s0">if </span><span class="s1">remainingBytes </span><span class="s4">&lt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bufferedData</span><span class="s2">) </span><span class="s4">- </span><span class="s1">bufferOffset</span><span class="s4">:</span>
                <span class="s1">bytesToRead </span><span class="s4">= </span><span class="s1">remainingBytes</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s4">= </span><span class="s5">[</span><span class="s1">bufferIndex</span><span class="s2">, </span><span class="s1">bufferOffset </span><span class="s4">+ </span><span class="s1">bytesToRead</span><span class="s5">]</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s1">bytesToRead </span><span class="s4">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bufferedData</span><span class="s2">) </span><span class="s4">- </span><span class="s1">bufferOffset</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s4">= </span><span class="s5">[</span><span class="s1">bufferIndex</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bufferedData</span><span class="s2">)</span><span class="s5">]</span>
                <span class="s1">bufferIndex </span><span class="s4">+= </span><span class="s7">1</span>
            <span class="s1">rv</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bufferedData</span><span class="s5">[</span><span class="s1">bufferOffset</span><span class="s4">:</span><span class="s1">bufferOffset </span><span class="s4">+ </span><span class="s1">bytesToRead</span><span class="s5">]</span><span class="s2">)</span>
            <span class="s1">remainingBytes </span><span class="s4">-= </span><span class="s1">bytesToRead</span>

            <span class="s1">bufferOffset </span><span class="s4">= </span><span class="s7">0</span>

        <span class="s0">if </span><span class="s1">remainingBytes</span><span class="s4">:</span>
            <span class="s1">rv</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_readStream</span><span class="s2">(</span><span class="s1">remainingBytes</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">rv</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">HTMLInputStream</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s4">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s3"># Work around Python bug #20007: read(0) closes the connection.</span>
    <span class="s3"># http://bugs.python.org/issue20007</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">http_client</span><span class="s2">.</span><span class="s1">HTTPResponse</span><span class="s2">) </span><span class="s0">or</span>
        <span class="s3"># Also check for addinfourl wrapping HTTPResponse</span>
        <span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">response</span><span class="s2">.</span><span class="s1">addbase</span><span class="s2">) </span><span class="s0">and</span>
         <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">http_client</span><span class="s2">.</span><span class="s1">HTTPResponse</span><span class="s2">)))</span><span class="s4">:</span>
        <span class="s1">isUnicode </span><span class="s4">= </span><span class="s0">False</span>
    <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s6">&quot;read&quot;</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">isUnicode </span><span class="s4">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">source</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s7">0</span><span class="s2">), </span><span class="s1">text_type</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s4">:</span>
        <span class="s1">isUnicode </span><span class="s4">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">text_type</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">isUnicode</span><span class="s4">:</span>
        <span class="s1">encodings </span><span class="s4">= </span><span class="s5">[</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">kwargs </span><span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s6">&quot;_encoding&quot;</span><span class="s2">)</span><span class="s5">]</span>
        <span class="s0">if </span><span class="s1">encodings</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s6">&quot;Cannot set an encoding with a unicode input, set %r&quot; </span><span class="s4">% </span><span class="s1">encodings</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">HTMLUnicodeInputStream</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s4">**</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s4">:</span>
        <span class="s0">return </span><span class="s1">HTMLBinaryInputStream</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s4">**</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">HTMLUnicodeInputStream</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s3">&quot;&quot;&quot;Provides a unicode stream of characters to the HTMLTokenizer. 
 
    This class takes care of character encoding and removing or replacing 
    incorrect byte-sequences and also provides column and line tracking. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">_defaultChunkSize </span><span class="s4">= </span><span class="s7">10240</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Initialises the HTMLInputStream. 
 
        HTMLInputStream(source, [encoding]) -&gt; Normalized stream from source 
        for use by html5lib. 
 
        source can be either a file-object, local filename or a string. 
 
        The optional encoding parameter must be a string that indicates 
        the encoding.  If specified, that encoding will be used, 
        regardless of any BOM or later declaration (such as in a meta 
        element) 
 
        &quot;&quot;&quot;</span>

        <span class="s0">if not </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">supports_lone_surrogates</span><span class="s4">:</span>
            <span class="s3"># Such platforms will have already checked for such</span>
            <span class="s3"># surrogate errors, so no need to do this checking.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reportCharacterErrors </span><span class="s4">= </span><span class="s0">None</span>
        <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s6">&quot;\U0010FFFF&quot;</span><span class="s2">) </span><span class="s4">== </span><span class="s7">1</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reportCharacterErrors </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">characterErrorsUCS4</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reportCharacterErrors </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">characterErrorsUCS2</span>

        <span class="s3"># List of where new lines occur</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">newLines </span><span class="s4">= </span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding </span><span class="s4">= </span><span class="s2">(</span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s2">), </span><span class="s6">&quot;certain&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dataStream </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">openStream</span><span class="s2">(</span><span class="s1">source</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">reset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunk </span><span class="s4">= </span><span class="s6">&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize </span><span class="s4">= </span><span class="s7">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">= </span><span class="s7">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">errors </span><span class="s4">= </span><span class="s5">[]</span>

        <span class="s3"># number of (complete) lines in previous chunks</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">prevNumLines </span><span class="s4">= </span><span class="s7">0</span>
        <span class="s3"># number of columns in the last line of the previous chunk</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">prevNumCols </span><span class="s4">= </span><span class="s7">0</span>

        <span class="s3"># Deal with CR LF and surrogates split over chunk boundaries</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bufferedCharacter </span><span class="s4">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">openStream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Produces a file object from source. 
 
        source can be either a file object, local filename or a string. 
 
        &quot;&quot;&quot;</span>
        <span class="s3"># Already a file object</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s6">'read'</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s1">stream </span><span class="s4">= </span><span class="s1">source</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s1">stream </span><span class="s4">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">source</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">stream</span>

    <span class="s0">def </span><span class="s1">_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">chunk </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunk</span>
        <span class="s1">nLines </span><span class="s4">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s6">'\n'</span><span class="s2">, </span><span class="s7">0</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s1">positionLine </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prevNumLines </span><span class="s4">+ </span><span class="s1">nLines</span>
        <span class="s1">lastLinePos </span><span class="s4">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">rfind</span><span class="s2">(</span><span class="s6">'\n'</span><span class="s2">, </span><span class="s7">0</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">lastLinePos </span><span class="s4">== -</span><span class="s7">1</span><span class="s4">:</span>
            <span class="s1">positionColumn </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prevNumCols </span><span class="s4">+ </span><span class="s1">offset</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s1">positionColumn </span><span class="s4">= </span><span class="s1">offset </span><span class="s4">- </span><span class="s2">(</span><span class="s1">lastLinePos </span><span class="s4">+ </span><span class="s7">1</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">positionLine</span><span class="s2">, </span><span class="s1">positionColumn</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Returns (line, col) of the current position in the stream.&quot;&quot;&quot;</span>
        <span class="s1">line</span><span class="s2">, </span><span class="s1">col </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">line </span><span class="s4">+ </span><span class="s7">1</span><span class="s2">, </span><span class="s1">col</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">char</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot; Read one character from the stream or queue if available. Return 
            EOF when EOF is reached. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Read a new chunk from the input stream if necessary</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize</span><span class="s4">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readChunk</span><span class="s2">()</span><span class="s4">:</span>
                <span class="s0">return </span><span class="s1">EOF</span>

        <span class="s1">chunkOffset </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset</span>
        <span class="s1">char </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunk</span><span class="s5">[</span><span class="s1">chunkOffset</span><span class="s5">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">= </span><span class="s1">chunkOffset </span><span class="s4">+ </span><span class="s7">1</span>

        <span class="s0">return </span><span class="s1">char</span>

    <span class="s0">def </span><span class="s1">readChunk</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">chunkSize</span><span class="s4">=</span><span class="s0">None</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">if </span><span class="s1">chunkSize </span><span class="s0">is None</span><span class="s4">:</span>
            <span class="s1">chunkSize </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_defaultChunkSize</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">prevNumLines</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prevNumCols </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunk </span><span class="s4">= </span><span class="s6">&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize </span><span class="s4">= </span><span class="s7">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">= </span><span class="s7">0</span>

        <span class="s1">data </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dataStream</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">chunkSize</span><span class="s2">)</span>

        <span class="s3"># Deal with CR LF and surrogates broken across chunks</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bufferedCharacter</span><span class="s4">:</span>
            <span class="s1">data </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bufferedCharacter </span><span class="s4">+ </span><span class="s1">data</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_bufferedCharacter </span><span class="s4">= </span><span class="s0">None</span>
        <span class="s0">elif not </span><span class="s1">data</span><span class="s4">:</span>
            <span class="s3"># We have no more data, bye-bye stream</span>
            <span class="s0">return False</span>

        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) </span><span class="s4">&gt; </span><span class="s7">1</span><span class="s4">:</span>
            <span class="s1">lastv </span><span class="s4">= </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">data</span><span class="s5">[</span><span class="s4">-</span><span class="s7">1</span><span class="s5">]</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">lastv </span><span class="s4">== </span><span class="s7">0x0D </span><span class="s0">or </span><span class="s7">0xD800 </span><span class="s4">&lt;= </span><span class="s1">lastv </span><span class="s4">&lt;= </span><span class="s7">0xDBFF</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bufferedCharacter </span><span class="s4">= </span><span class="s1">data</span><span class="s5">[</span><span class="s4">-</span><span class="s7">1</span><span class="s5">]</span>
                <span class="s1">data </span><span class="s4">= </span><span class="s1">data</span><span class="s5">[</span><span class="s4">:-</span><span class="s7">1</span><span class="s5">]</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">reportCharacterErrors</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reportCharacterErrors</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s3"># Replace invalid characters</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">&quot;\r\n&quot;</span><span class="s2">, </span><span class="s6">&quot;\n&quot;</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">&quot;\r&quot;</span><span class="s2">, </span><span class="s6">&quot;\n&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunk </span><span class="s4">= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize </span><span class="s4">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">characterErrorsUCS4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">invalid_unicode_re</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)))</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s6">&quot;invalid-codepoint&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">characterErrorsUCS2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3"># Someone picked the wrong compile option</span>
        <span class="s3"># You lose</span>
        <span class="s1">skip </span><span class="s4">= </span><span class="s0">False</span>
        <span class="s0">for </span><span class="s1">match </span><span class="s0">in </span><span class="s1">invalid_unicode_re</span><span class="s2">.</span><span class="s1">finditer</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s0">if </span><span class="s1">skip</span><span class="s4">:</span>
                <span class="s0">continue</span>
            <span class="s1">codepoint </span><span class="s4">= </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">match</span><span class="s2">.</span><span class="s1">group</span><span class="s2">())</span>
            <span class="s1">pos </span><span class="s4">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
            <span class="s3"># Pretty sure there should be endianness issues here</span>
            <span class="s0">if </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">isSurrogatePair</span><span class="s2">(</span><span class="s1">data</span><span class="s5">[</span><span class="s1">pos</span><span class="s4">:</span><span class="s1">pos </span><span class="s4">+ </span><span class="s7">2</span><span class="s5">]</span><span class="s2">)</span><span class="s4">:</span>
                <span class="s3"># We have a surrogate pair!</span>
                <span class="s1">char_val </span><span class="s4">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">surrogatePairToCodepoint</span><span class="s2">(</span><span class="s1">data</span><span class="s5">[</span><span class="s1">pos</span><span class="s4">:</span><span class="s1">pos </span><span class="s4">+ </span><span class="s7">2</span><span class="s5">]</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">char_val </span><span class="s0">in </span><span class="s1">non_bmp_invalid_codepoints</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s6">&quot;invalid-codepoint&quot;</span><span class="s2">)</span>
                <span class="s1">skip </span><span class="s4">= </span><span class="s0">True</span>
            <span class="s0">elif </span><span class="s2">(</span><span class="s1">codepoint </span><span class="s4">&gt;= </span><span class="s7">0xD800 </span><span class="s0">and </span><span class="s1">codepoint </span><span class="s4">&lt;= </span><span class="s7">0xDFFF </span><span class="s0">and</span>
                  <span class="s1">pos </span><span class="s4">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) </span><span class="s4">- </span><span class="s7">1</span><span class="s2">)</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s6">&quot;invalid-codepoint&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s1">skip </span><span class="s4">= </span><span class="s0">False</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s6">&quot;invalid-codepoint&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">charsUntil</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">characters</span><span class="s2">, </span><span class="s1">opposite</span><span class="s4">=</span><span class="s0">False</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot; Returns a string of characters from the stream up to but not 
        including any character in 'characters' or EOF. 'characters' must be 
        a container that supports the 'in' method and iteration over its 
        characters. 
        &quot;&quot;&quot;</span>

        <span class="s3"># Use a cache of regexps to find the required characters</span>
        <span class="s0">try</span><span class="s4">:</span>
            <span class="s1">chars </span><span class="s4">= </span><span class="s1">charsUntilRegEx</span><span class="s5">[</span><span class="s2">(</span><span class="s1">characters</span><span class="s2">, </span><span class="s1">opposite</span><span class="s2">)</span><span class="s5">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s0">if __debug__</span><span class="s4">:</span>
                <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">characters</span><span class="s4">:</span>
                    <span class="s0">assert</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s4">&lt; </span><span class="s7">128</span><span class="s2">)</span>
            <span class="s1">regex </span><span class="s4">= </span><span class="s6">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s5">[</span><span class="s6">&quot;\\x%02x&quot; </span><span class="s4">% </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">characters</span><span class="s5">]</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">opposite</span><span class="s4">:</span>
                <span class="s1">regex </span><span class="s4">= </span><span class="s6">&quot;^%s&quot; </span><span class="s4">% </span><span class="s1">regex</span>
            <span class="s1">chars </span><span class="s4">= </span><span class="s1">charsUntilRegEx</span><span class="s5">[</span><span class="s2">(</span><span class="s1">characters</span><span class="s2">, </span><span class="s1">opposite</span><span class="s2">)</span><span class="s5">] </span><span class="s4">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s6">&quot;[%s]+&quot; </span><span class="s4">% </span><span class="s1">regex</span><span class="s2">)</span>

        <span class="s1">rv </span><span class="s4">= </span><span class="s5">[]</span>

        <span class="s0">while True</span><span class="s4">:</span>
            <span class="s3"># Find the longest matching prefix</span>
            <span class="s1">m </span><span class="s4">= </span><span class="s1">chars</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">m </span><span class="s0">is None</span><span class="s4">:</span>
                <span class="s3"># If nothing matched, and it wasn't because we ran out of chunk,</span>
                <span class="s3"># then stop</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize</span><span class="s4">:</span>
                    <span class="s0">break</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s1">end </span><span class="s4">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
                <span class="s3"># If not the whole chunk matched, return everything</span>
                <span class="s3"># up to the part that didn't match</span>
                <span class="s0">if </span><span class="s1">end </span><span class="s4">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize</span><span class="s4">:</span>
                    <span class="s1">rv</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunk</span><span class="s5">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset</span><span class="s4">:</span><span class="s1">end</span><span class="s5">]</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">= </span><span class="s1">end</span>
                    <span class="s0">break</span>
            <span class="s3"># If the whole remainder of the chunk matched,</span>
            <span class="s3"># use it all and read the next chunk</span>
            <span class="s1">rv</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunk</span><span class="s5">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset</span><span class="s4">:</span><span class="s5">]</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readChunk</span><span class="s2">()</span><span class="s4">:</span>
                <span class="s3"># Reached EOF</span>
                <span class="s0">break</span>

        <span class="s1">r </span><span class="s4">= </span><span class="s6">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">rv</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">r</span>

    <span class="s0">def </span><span class="s1">unget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">char</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3"># Only one character is allowed to be ungotten at once - it must</span>
        <span class="s3"># be consumed again before any further call to unget</span>
        <span class="s0">if </span><span class="s1">char </span><span class="s0">is not </span><span class="s1">EOF</span><span class="s4">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">== </span><span class="s7">0</span><span class="s4">:</span>
                <span class="s3"># unget is called quite rarely, so it's a good idea to do</span>
                <span class="s3"># more work here if it saves a bit of work in the frequently</span>
                <span class="s3"># called char and charsUntil.</span>
                <span class="s3"># So, just prepend the ungotten character onto the current</span>
                <span class="s3"># chunk:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">chunk </span><span class="s4">= </span><span class="s1">char </span><span class="s4">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunk</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkSize </span><span class="s4">+= </span><span class="s7">1</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset </span><span class="s4">-= </span><span class="s7">1</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunk</span><span class="s5">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">chunkOffset</span><span class="s5">] </span><span class="s4">== </span><span class="s1">char</span>


<span class="s0">class </span><span class="s1">HTMLBinaryInputStream</span><span class="s2">(</span><span class="s1">HTMLUnicodeInputStream</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s3">&quot;&quot;&quot;Provides a unicode stream of characters to the HTMLTokenizer. 
 
    This class takes care of character encoding and removing or replacing 
    incorrect byte-sequences and also provides column and line tracking. 
 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">override_encoding</span><span class="s4">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">transport_encoding</span><span class="s4">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">same_origin_parent_encoding</span><span class="s4">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">likely_encoding</span><span class="s4">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">default_encoding</span><span class="s4">=</span><span class="s6">&quot;windows-1252&quot;</span><span class="s2">, </span><span class="s1">useChardet</span><span class="s4">=</span><span class="s0">True</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Initialises the HTMLInputStream. 
 
        HTMLInputStream(source, [encoding]) -&gt; Normalized stream from source 
        for use by html5lib. 
 
        source can be either a file-object, local filename or a string. 
 
        The optional encoding parameter must be a string that indicates 
        the encoding.  If specified, that encoding will be used, 
        regardless of any BOM or later declaration (such as in a meta 
        element) 
 
        &quot;&quot;&quot;</span>
        <span class="s3"># Raw Stream - for unicode objects this will encode to utf-8 and set</span>
        <span class="s3">#              self.charEncoding as appropriate</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">openStream</span><span class="s2">(</span><span class="s1">source</span><span class="s2">)</span>

        <span class="s1">HTMLUnicodeInputStream</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">)</span>

        <span class="s3"># Encoding Information</span>
        <span class="s3"># Number of bytes to use when looking for a meta element with</span>
        <span class="s3"># encoding information</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">numBytesMeta </span><span class="s4">= </span><span class="s7">1024</span>
        <span class="s3"># Number of bytes to use when using detecting encoding using chardet</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">numBytesChardet </span><span class="s4">= </span><span class="s7">100</span>
        <span class="s3"># Things from args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">override_encoding </span><span class="s4">= </span><span class="s1">override_encoding</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transport_encoding </span><span class="s4">= </span><span class="s1">transport_encoding</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">same_origin_parent_encoding </span><span class="s4">= </span><span class="s1">same_origin_parent_encoding</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">likely_encoding </span><span class="s4">= </span><span class="s1">likely_encoding</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">default_encoding </span><span class="s4">= </span><span class="s1">default_encoding</span>

        <span class="s3"># Determine encoding</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">determineEncoding</span><span class="s2">(</span><span class="s1">useChardet</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None</span>

        <span class="s3"># Call superclass</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">reset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dataStream </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span><span class="s2">.</span><span class="s1">codec_info</span><span class="s2">.</span><span class="s1">streamreader</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">, </span><span class="s6">'replace'</span><span class="s2">)</span>
        <span class="s1">HTMLUnicodeInputStream</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">openStream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Produces a file object from source. 
 
        source can be either a file object, local filename or a string. 
 
        &quot;&quot;&quot;</span>
        <span class="s3"># Already a file object</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s6">'read'</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s1">stream </span><span class="s4">= </span><span class="s1">source</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s1">stream </span><span class="s4">= </span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">source</span><span class="s2">)</span>

        <span class="s0">try</span><span class="s4">:</span>
            <span class="s1">stream</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">())</span>
        <span class="s0">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s1">stream </span><span class="s4">= </span><span class="s1">BufferedStream</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">stream</span>

    <span class="s0">def </span><span class="s1">determineEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">chardet</span><span class="s4">=</span><span class="s0">True</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3"># BOMs take precedence over everything</span>
        <span class="s3"># This will also read past the BOM if present</span>
        <span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">detectBOM</span><span class="s2">(), </span><span class="s6">&quot;certain&quot;</span>
        <span class="s0">if </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">charEncoding</span>

        <span class="s3"># If we've been overridden, we've been overridden</span>
        <span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">override_encoding</span><span class="s2">), </span><span class="s6">&quot;certain&quot;</span>
        <span class="s0">if </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">charEncoding</span>

        <span class="s3"># Now check the transport layer</span>
        <span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">transport_encoding</span><span class="s2">), </span><span class="s6">&quot;certain&quot;</span>
        <span class="s0">if </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">charEncoding</span>

        <span class="s3"># Look for meta elements with encoding information</span>
        <span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">detectEncodingMeta</span><span class="s2">(), </span><span class="s6">&quot;tentative&quot;</span>
        <span class="s0">if </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">charEncoding</span>

        <span class="s3"># Parent document encoding</span>
        <span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">same_origin_parent_encoding</span><span class="s2">), </span><span class="s6">&quot;tentative&quot;</span>
        <span class="s0">if </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None and not </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s6">&quot;utf-16&quot;</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">charEncoding</span>

        <span class="s3"># &quot;likely&quot; encoding</span>
        <span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">likely_encoding</span><span class="s2">), </span><span class="s6">&quot;tentative&quot;</span>
        <span class="s0">if </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">charEncoding</span>

        <span class="s3"># Guess with chardet, if available</span>
        <span class="s0">if </span><span class="s1">chardet</span><span class="s4">:</span>
            <span class="s0">try</span><span class="s4">:</span>
                <span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">chardet</span><span class="s2">.</span><span class="s1">universaldetector </span><span class="s0">import </span><span class="s1">UniversalDetector</span>
            <span class="s0">except </span><span class="s1">ImportError</span><span class="s4">:</span>
                <span class="s0">pass</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s1">buffers </span><span class="s4">= </span><span class="s5">[]</span>
                <span class="s1">detector </span><span class="s4">= </span><span class="s1">UniversalDetector</span><span class="s2">()</span>
                <span class="s0">while not </span><span class="s1">detector</span><span class="s2">.</span><span class="s1">done</span><span class="s4">:</span>
                    <span class="s1">buffer </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numBytesChardet</span><span class="s2">)</span>
                    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span>
                    <span class="s0">if not </span><span class="s1">buffer</span><span class="s4">:</span>
                        <span class="s0">break</span>
                    <span class="s1">buffers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)</span>
                    <span class="s1">detector</span><span class="s2">.</span><span class="s1">feed</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)</span>
                <span class="s1">detector</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
                <span class="s1">encoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">detector</span><span class="s2">.</span><span class="s1">result</span><span class="s5">[</span><span class="s6">'encoding'</span><span class="s5">]</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s7">0</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">encoding </span><span class="s0">is not None</span><span class="s4">:</span>
                    <span class="s0">return </span><span class="s1">encoding</span><span class="s2">, </span><span class="s6">&quot;tentative&quot;</span>

        <span class="s3"># Try the default encoding</span>
        <span class="s1">charEncoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">default_encoding</span><span class="s2">), </span><span class="s6">&quot;tentative&quot;</span>
        <span class="s0">if </span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s0">is not None</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">charEncoding</span>

        <span class="s3"># Fallback to html5lib's default if even that hasn't worked</span>
        <span class="s0">return </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s6">&quot;windows-1252&quot;</span><span class="s2">), </span><span class="s6">&quot;tentative&quot;</span>

    <span class="s0">def </span><span class="s1">changeEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">newEncoding</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">1</span><span class="s5">] </span><span class="s4">!= </span><span class="s6">&quot;certain&quot;</span>
        <span class="s1">newEncoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">newEncoding</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">newEncoding </span><span class="s0">is None</span><span class="s4">:</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">newEncoding</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s6">&quot;utf-16be&quot;</span><span class="s2">, </span><span class="s6">&quot;utf-16le&quot;</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s1">newEncoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">newEncoding </span><span class="s0">is not None</span>
        <span class="s0">elif </span><span class="s1">newEncoding </span><span class="s4">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding </span><span class="s4">= </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span><span class="s2">, </span><span class="s6">&quot;certain&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s7">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding </span><span class="s4">= </span><span class="s2">(</span><span class="s1">newEncoding</span><span class="s2">, </span><span class="s6">&quot;certain&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
            <span class="s0">raise </span><span class="s1">_ReparseException</span><span class="s2">(</span><span class="s6">&quot;Encoding changed from %s to %s&quot; </span><span class="s4">% </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span><span class="s2">, </span><span class="s1">newEncoding</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">detectBOM</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Attempts to detect at BOM at the start of the stream. If 
        an encoding can be determined from the BOM return the name of the 
        encoding otherwise return None&quot;&quot;&quot;</span>
        <span class="s1">bomDict </span><span class="s4">= </span><span class="s5">{</span>
            <span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF8</span><span class="s4">: </span><span class="s6">'utf-8'</span><span class="s2">,</span>
            <span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF16_LE</span><span class="s4">: </span><span class="s6">'utf-16le'</span><span class="s2">, </span><span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF16_BE</span><span class="s4">: </span><span class="s6">'utf-16be'</span><span class="s2">,</span>
            <span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF32_LE</span><span class="s4">: </span><span class="s6">'utf-32le'</span><span class="s2">, </span><span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF32_BE</span><span class="s4">: </span><span class="s6">'utf-32be'</span>
        <span class="s5">}</span>

        <span class="s3"># Go to beginning of file and read in 4 bytes</span>
        <span class="s1">string </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s7">4</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">string</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span>

        <span class="s3"># Try detecting the BOM using bytes from the string</span>
        <span class="s1">encoding </span><span class="s4">= </span><span class="s1">bomDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">string</span><span class="s5">[</span><span class="s4">:</span><span class="s7">3</span><span class="s5">]</span><span class="s2">)         </span><span class="s3"># UTF-8</span>
        <span class="s1">seek </span><span class="s4">= </span><span class="s7">3</span>
        <span class="s0">if not </span><span class="s1">encoding</span><span class="s4">:</span>
            <span class="s3"># Need to detect UTF-32 before UTF-16</span>
            <span class="s1">encoding </span><span class="s4">= </span><span class="s1">bomDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">string</span><span class="s2">)         </span><span class="s3"># UTF-32</span>
            <span class="s1">seek </span><span class="s4">= </span><span class="s7">4</span>
            <span class="s0">if not </span><span class="s1">encoding</span><span class="s4">:</span>
                <span class="s1">encoding </span><span class="s4">= </span><span class="s1">bomDict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">string</span><span class="s5">[</span><span class="s4">:</span><span class="s7">2</span><span class="s5">]</span><span class="s2">)  </span><span class="s3"># UTF-16</span>
                <span class="s1">seek </span><span class="s4">= </span><span class="s7">2</span>

        <span class="s3"># Set the read position past the BOM if one was found, otherwise</span>
        <span class="s3"># set it to the start of the stream</span>
        <span class="s0">if </span><span class="s1">encoding</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">seek</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s7">0</span><span class="s2">)</span>
            <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">detectEncodingMeta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Report the encoding declared by the meta element 
        &quot;&quot;&quot;</span>
        <span class="s1">buffer </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">numBytesMeta</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s1">parser </span><span class="s4">= </span><span class="s1">EncodingParser</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rawStream</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s7">0</span><span class="s2">)</span>
        <span class="s1">encoding </span><span class="s4">= </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">getEncoding</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">encoding </span><span class="s0">is not None and </span><span class="s1">encoding</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s6">&quot;utf-16be&quot;</span><span class="s2">, </span><span class="s6">&quot;utf-16le&quot;</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s1">encoding </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">encoding</span>


<span class="s0">class </span><span class="s1">EncodingBytes</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s3">&quot;&quot;&quot;String-like object with an associated position and various extra methods 
    If the position is ever greater than the string length then an exception is 
    raised&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">.</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3"># pylint:disable=unused-argument</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= -</span><span class="s7">1</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__next__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">p </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">+ </span><span class="s7">1</span>
        <span class="s0">if </span><span class="s1">p </span><span class="s4">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s0">elif </span><span class="s1">p </span><span class="s4">&lt; </span><span class="s7">0</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">TypeError</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s5">[</span><span class="s1">p</span><span class="s4">:</span><span class="s1">p </span><span class="s4">+ </span><span class="s7">1</span><span class="s5">]</span>

    <span class="s0">def </span><span class="s1">next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3"># Py2 compat</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__next__</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">previous</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">p </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position</span>
        <span class="s0">if </span><span class="s1">p </span><span class="s4">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s0">elif </span><span class="s1">p </span><span class="s4">&lt; </span><span class="s7">0</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">TypeError</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">p </span><span class="s4">= </span><span class="s1">p </span><span class="s4">- </span><span class="s7">1</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s5">[</span><span class="s1">p</span><span class="s4">:</span><span class="s1">p </span><span class="s4">+ </span><span class="s7">1</span><span class="s5">]</span>

    <span class="s0">def </span><span class="s1">setPosition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">position</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">position</span>

    <span class="s0">def </span><span class="s1">getPosition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">&gt;= </span><span class="s7">0</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_position</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s0">return None</span>

    <span class="s1">position </span><span class="s4">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">getPosition</span><span class="s2">, </span><span class="s1">setPosition</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getCurrentByte</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s5">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s4">:</span><span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s4">+ </span><span class="s7">1</span><span class="s5">]</span>

    <span class="s1">currentByte </span><span class="s4">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">getCurrentByte</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">skip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">chars</span><span class="s4">=</span><span class="s1">spaceCharactersBytes</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Skip past a list of characters&quot;&quot;&quot;</span>
        <span class="s1">p </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">position               </span><span class="s3"># use property for the error-checking</span>
        <span class="s0">while </span><span class="s1">p </span><span class="s4">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s1">c </span><span class="s4">= </span><span class="s1">self</span><span class="s5">[</span><span class="s1">p</span><span class="s4">:</span><span class="s1">p </span><span class="s4">+ </span><span class="s7">1</span><span class="s5">]</span>
            <span class="s0">if </span><span class="s1">c </span><span class="s0">not in </span><span class="s1">chars</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">p</span>
                <span class="s0">return </span><span class="s1">c</span>
            <span class="s1">p </span><span class="s4">+= </span><span class="s7">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">p</span>
        <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">skipUntil</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">chars</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">p </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span>
        <span class="s0">while </span><span class="s1">p </span><span class="s4">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s1">c </span><span class="s4">= </span><span class="s1">self</span><span class="s5">[</span><span class="s1">p</span><span class="s4">:</span><span class="s1">p </span><span class="s4">+ </span><span class="s7">1</span><span class="s5">]</span>
            <span class="s0">if </span><span class="s1">c </span><span class="s0">in </span><span class="s1">chars</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">p</span>
                <span class="s0">return </span><span class="s1">c</span>
            <span class="s1">p </span><span class="s4">+= </span><span class="s7">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">p</span>
        <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">matchBytes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Look for a sequence of bytes at the start of a string. If the bytes 
        are found return True and advance the position to the byte after the 
        match. Otherwise return False and leave the position alone&quot;&quot;&quot;</span>
        <span class="s1">rv </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">rv</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">position </span><span class="s4">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">rv</span>

    <span class="s0">def </span><span class="s1">jumpTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Look for the next sequence of bytes matching a given sequence. If 
        a match is found advance the position to the last byte of the match&quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_position </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">position</span><span class="s2">) </span><span class="s4">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">) </span><span class="s4">- </span><span class="s7">1</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s4">:</span>
            <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s0">return True</span>


<span class="s0">class </span><span class="s1">EncodingParser</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s3">&quot;&quot;&quot;Mini parser for detecting character encoding from meta elements&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;string - the data to work on for encoding detection&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">EncodingBytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">encoding </span><span class="s4">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">getEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">if </span><span class="s6">b&quot;&lt;meta&quot; </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s4">:</span>
            <span class="s0">return None</span>

        <span class="s1">methodDispatch </span><span class="s4">= </span><span class="s2">(</span>
            <span class="s2">(</span><span class="s6">b&quot;&lt;!--&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handleComment</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s6">b&quot;&lt;meta&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handleMeta</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s6">b&quot;&lt;/&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handlePossibleEndTag</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s6">b&quot;&lt;!&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handleOther</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s6">b&quot;&lt;?&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handleOther</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s6">b&quot;&lt;&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handlePossibleStartTag</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s4">:</span>
            <span class="s1">keepParsing </span><span class="s4">= </span><span class="s0">True</span>
            <span class="s0">try</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">jumpTo</span><span class="s2">(</span><span class="s6">b&quot;&lt;&quot;</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">StopIteration</span><span class="s4">:</span>
                <span class="s0">break</span>
            <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">method </span><span class="s0">in </span><span class="s1">methodDispatch</span><span class="s4">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">matchBytes</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span><span class="s4">:</span>
                    <span class="s0">try</span><span class="s4">:</span>
                        <span class="s1">keepParsing </span><span class="s4">= </span><span class="s1">method</span><span class="s2">()</span>
                        <span class="s0">break</span>
                    <span class="s0">except </span><span class="s1">StopIteration</span><span class="s4">:</span>
                        <span class="s1">keepParsing </span><span class="s4">= </span><span class="s0">False</span>
                        <span class="s0">break</span>
            <span class="s0">if not </span><span class="s1">keepParsing</span><span class="s4">:</span>
                <span class="s0">break</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">encoding</span>

    <span class="s0">def </span><span class="s1">handleComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Skip over comments&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">jumpTo</span><span class="s2">(</span><span class="s6">b&quot;--&gt;&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">handleMeta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">currentByte </span><span class="s0">not in </span><span class="s1">spaceCharactersBytes</span><span class="s4">:</span>
            <span class="s3"># if we have &lt;meta not followed by a space so just keep going</span>
            <span class="s0">return True</span>
        <span class="s3"># We have a valid meta element we want to search for attributes</span>
        <span class="s1">hasPragma </span><span class="s4">= </span><span class="s0">False</span>
        <span class="s1">pendingEncoding </span><span class="s4">= </span><span class="s0">None</span>
        <span class="s0">while True</span><span class="s4">:</span>
            <span class="s3"># Try to find the next attribute after the current position</span>
            <span class="s1">attr </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAttribute</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">attr </span><span class="s0">is None</span><span class="s4">:</span>
                <span class="s0">return True</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s0">if </span><span class="s1">attr</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s4">== </span><span class="s6">b&quot;http-equiv&quot;</span><span class="s4">:</span>
                    <span class="s1">hasPragma </span><span class="s4">= </span><span class="s1">attr</span><span class="s5">[</span><span class="s7">1</span><span class="s5">] </span><span class="s4">== </span><span class="s6">b&quot;content-type&quot;</span>
                    <span class="s0">if </span><span class="s1">hasPragma </span><span class="s0">and </span><span class="s1">pendingEncoding </span><span class="s0">is not None</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">encoding </span><span class="s4">= </span><span class="s1">pendingEncoding</span>
                        <span class="s0">return False</span>
                <span class="s0">elif </span><span class="s1">attr</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s4">== </span><span class="s6">b&quot;charset&quot;</span><span class="s4">:</span>
                    <span class="s1">tentativeEncoding </span><span class="s4">= </span><span class="s1">attr</span><span class="s5">[</span><span class="s7">1</span><span class="s5">]</span>
                    <span class="s1">codec </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">tentativeEncoding</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">codec </span><span class="s0">is not None</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">encoding </span><span class="s4">= </span><span class="s1">codec</span>
                        <span class="s0">return False</span>
                <span class="s0">elif </span><span class="s1">attr</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] </span><span class="s4">== </span><span class="s6">b&quot;content&quot;</span><span class="s4">:</span>
                    <span class="s1">contentParser </span><span class="s4">= </span><span class="s1">ContentAttrParser</span><span class="s2">(</span><span class="s1">EncodingBytes</span><span class="s2">(</span><span class="s1">attr</span><span class="s5">[</span><span class="s7">1</span><span class="s5">]</span><span class="s2">))</span>
                    <span class="s1">tentativeEncoding </span><span class="s4">= </span><span class="s1">contentParser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">tentativeEncoding </span><span class="s0">is not None</span><span class="s4">:</span>
                        <span class="s1">codec </span><span class="s4">= </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">tentativeEncoding</span><span class="s2">)</span>
                        <span class="s0">if </span><span class="s1">codec </span><span class="s0">is not None</span><span class="s4">:</span>
                            <span class="s0">if </span><span class="s1">hasPragma</span><span class="s4">:</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">encoding </span><span class="s4">= </span><span class="s1">codec</span>
                                <span class="s0">return False</span>
                            <span class="s0">else</span><span class="s4">:</span>
                                <span class="s1">pendingEncoding </span><span class="s4">= </span><span class="s1">codec</span>

    <span class="s0">def </span><span class="s1">handlePossibleStartTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handlePossibleTag</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">handlePossibleEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handlePossibleTag</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">handlePossibleTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">endTag</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s0">if </span><span class="s1">data</span><span class="s2">.</span><span class="s1">currentByte </span><span class="s0">not in </span><span class="s1">asciiLettersBytes</span><span class="s4">:</span>
            <span class="s3"># If the next byte is not an ascii letter either ignore this</span>
            <span class="s3"># fragment (possible start tag case) or treat it according to</span>
            <span class="s3"># handleOther</span>
            <span class="s0">if </span><span class="s1">endTag</span><span class="s4">:</span>
                <span class="s1">data</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">handleOther</span><span class="s2">()</span>
            <span class="s0">return True</span>

        <span class="s1">c </span><span class="s4">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">skipUntil</span><span class="s2">(</span><span class="s1">spacesAngleBrackets</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">c </span><span class="s4">== </span><span class="s6">b&quot;&lt;&quot;</span><span class="s4">:</span>
            <span class="s3"># return to the first step in the overall &quot;two step&quot; algorithm</span>
            <span class="s3"># reprocessing the &lt; byte</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s3"># Read all attributes</span>
            <span class="s1">attr </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAttribute</span><span class="s2">()</span>
            <span class="s0">while </span><span class="s1">attr </span><span class="s0">is not None</span><span class="s4">:</span>
                <span class="s1">attr </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getAttribute</span><span class="s2">()</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">handleOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">jumpTo</span><span class="s2">(</span><span class="s6">b&quot;&gt;&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getAttribute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s3">&quot;&quot;&quot;Return a name,value pair for the next attribute in the stream, 
        if one is found, or None&quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s3"># Step 1 (skip chars)</span>
        <span class="s1">c </span><span class="s4">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s1">spaceCharactersBytes </span><span class="s4">| </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s5">[</span><span class="s6">b&quot;/&quot;</span><span class="s5">]</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">c </span><span class="s0">is None or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s4">== </span><span class="s7">1</span>
        <span class="s3"># Step 2</span>
        <span class="s0">if </span><span class="s1">c </span><span class="s0">in </span><span class="s2">(</span><span class="s6">b&quot;&gt;&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s0">return None</span>
        <span class="s3"># Step 3</span>
        <span class="s1">attrName </span><span class="s4">= </span><span class="s5">[]</span>
        <span class="s1">attrValue </span><span class="s4">= </span><span class="s5">[]</span>
        <span class="s3"># Step 4 attribute name</span>
        <span class="s0">while True</span><span class="s4">:</span>
            <span class="s0">if </span><span class="s1">c </span><span class="s4">== </span><span class="s6">b&quot;=&quot; </span><span class="s0">and </span><span class="s1">attrName</span><span class="s4">:</span>
                <span class="s0">break</span>
            <span class="s0">elif </span><span class="s1">c </span><span class="s0">in </span><span class="s1">spaceCharactersBytes</span><span class="s4">:</span>
                <span class="s3"># Step 6!</span>
                <span class="s1">c </span><span class="s4">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">()</span>
                <span class="s0">break</span>
            <span class="s0">elif </span><span class="s1">c </span><span class="s0">in </span><span class="s2">(</span><span class="s6">b&quot;/&quot;</span><span class="s2">, </span><span class="s6">b&quot;&gt;&quot;</span><span class="s2">)</span><span class="s4">:</span>
                <span class="s0">return </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">attrName</span><span class="s2">), </span><span class="s6">b&quot;&quot;</span>
            <span class="s0">elif </span><span class="s1">c </span><span class="s0">in </span><span class="s1">asciiUppercaseBytes</span><span class="s4">:</span>
                <span class="s1">attrName</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
            <span class="s0">elif </span><span class="s1">c </span><span class="s0">is None</span><span class="s4">:</span>
                <span class="s0">return None</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s1">attrName</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
            <span class="s3"># Step 5</span>
            <span class="s1">c </span><span class="s4">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s3"># Step 7</span>
        <span class="s0">if </span><span class="s1">c </span><span class="s4">!= </span><span class="s6">b&quot;=&quot;</span><span class="s4">:</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">previous</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">attrName</span><span class="s2">), </span><span class="s6">b&quot;&quot;</span>
        <span class="s3"># Step 8</span>
        <span class="s1">next</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s3"># Step 9</span>
        <span class="s1">c </span><span class="s4">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">()</span>
        <span class="s3"># Step 10</span>
        <span class="s0">if </span><span class="s1">c </span><span class="s0">in </span><span class="s2">(</span><span class="s6">b&quot;'&quot;</span><span class="s2">, </span><span class="s6">b'&quot;'</span><span class="s2">)</span><span class="s4">:</span>
            <span class="s3"># 10.1</span>
            <span class="s1">quoteChar </span><span class="s4">= </span><span class="s1">c</span>
            <span class="s0">while True</span><span class="s4">:</span>
                <span class="s3"># 10.2</span>
                <span class="s1">c </span><span class="s4">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                <span class="s3"># 10.3</span>
                <span class="s0">if </span><span class="s1">c </span><span class="s4">== </span><span class="s1">quoteChar</span><span class="s4">:</span>
                    <span class="s1">next</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">attrName</span><span class="s2">), </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">attrValue</span><span class="s2">)</span>
                <span class="s3"># 10.4</span>
                <span class="s0">elif </span><span class="s1">c </span><span class="s0">in </span><span class="s1">asciiUppercaseBytes</span><span class="s4">:</span>
                    <span class="s1">attrValue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
                <span class="s3"># 10.5</span>
                <span class="s0">else</span><span class="s4">:</span>
                    <span class="s1">attrValue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">c </span><span class="s4">== </span><span class="s6">b&quot;&gt;&quot;</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">attrName</span><span class="s2">), </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">elif </span><span class="s1">c </span><span class="s0">in </span><span class="s1">asciiUppercaseBytes</span><span class="s4">:</span>
            <span class="s1">attrValue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">c </span><span class="s0">is None</span><span class="s4">:</span>
            <span class="s0">return None</span>
        <span class="s0">else</span><span class="s4">:</span>
            <span class="s1">attrValue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s3"># Step 11</span>
        <span class="s0">while True</span><span class="s4">:</span>
            <span class="s1">c </span><span class="s4">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">c </span><span class="s0">in </span><span class="s1">spacesAngleBrackets</span><span class="s4">:</span>
                <span class="s0">return </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">attrName</span><span class="s2">), </span><span class="s6">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">attrValue</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">c </span><span class="s0">in </span><span class="s1">asciiUppercaseBytes</span><span class="s4">:</span>
                <span class="s1">attrValue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>
            <span class="s0">elif </span><span class="s1">c </span><span class="s0">is None</span><span class="s4">:</span>
                <span class="s0">return None</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s1">attrValue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ContentAttrParser</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">parse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">try</span><span class="s4">:</span>
            <span class="s3"># Check if the attr name is charset</span>
            <span class="s3"># otherwise return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">jumpTo</span><span class="s2">(</span><span class="s6">b&quot;charset&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">position </span><span class="s4">+= </span><span class="s7">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">()</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">currentByte </span><span class="s4">== </span><span class="s6">b&quot;=&quot;</span><span class="s4">:</span>
                <span class="s3"># If there is no = sign keep looking for attrs</span>
                <span class="s0">return None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">position </span><span class="s4">+= </span><span class="s7">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">()</span>
            <span class="s3"># Look for an encoding between matching quote marks</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">currentByte </span><span class="s0">in </span><span class="s2">(</span><span class="s6">b'&quot;'</span><span class="s2">, </span><span class="s6">b&quot;'&quot;</span><span class="s2">)</span><span class="s4">:</span>
                <span class="s1">quoteMark </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">currentByte</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">position </span><span class="s4">+= </span><span class="s7">1</span>
                <span class="s1">oldPosition </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">position</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">jumpTo</span><span class="s2">(</span><span class="s1">quoteMark</span><span class="s2">)</span><span class="s4">:</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s5">[</span><span class="s1">oldPosition</span><span class="s4">:</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">position</span><span class="s5">]</span>
                <span class="s0">else</span><span class="s4">:</span>
                    <span class="s0">return None</span>
            <span class="s0">else</span><span class="s4">:</span>
                <span class="s3"># Unquoted value</span>
                <span class="s1">oldPosition </span><span class="s4">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">position</span>
                <span class="s0">try</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">skipUntil</span><span class="s2">(</span><span class="s1">spaceCharactersBytes</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s5">[</span><span class="s1">oldPosition</span><span class="s4">:</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">position</span><span class="s5">]</span>
                <span class="s0">except </span><span class="s1">StopIteration</span><span class="s4">:</span>
                    <span class="s3"># Return the whole remaining value</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s5">[</span><span class="s1">oldPosition</span><span class="s4">:</span><span class="s5">]</span>
        <span class="s0">except </span><span class="s1">StopIteration</span><span class="s4">:</span>
            <span class="s0">return None</span>


<span class="s0">def </span><span class="s1">lookupEncoding</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">)</span><span class="s4">:</span>
    <span class="s3">&quot;&quot;&quot;Return the python codec name corresponding to an encoding or None if the 
    string doesn't correspond to a valid encoding.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span><span class="s4">:</span>
        <span class="s0">try</span><span class="s4">:</span>
            <span class="s1">encoding </span><span class="s4">= </span><span class="s1">encoding</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s6">&quot;ascii&quot;</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">UnicodeDecodeError</span><span class="s4">:</span>
            <span class="s0">return None</span>

    <span class="s0">if </span><span class="s1">encoding </span><span class="s0">is not None</span><span class="s4">:</span>
        <span class="s0">try</span><span class="s4">:</span>
            <span class="s0">return </span><span class="s1">webencodings</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
            <span class="s0">return None</span>
    <span class="s0">else</span><span class="s4">:</span>
        <span class="s0">return None</span>
</pre>
</body>
</html>