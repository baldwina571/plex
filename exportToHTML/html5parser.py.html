<html>
<head>
<title>html5parser.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #b877db; font-style: italic;}
.s1 { color: #b6c4f2;}
.s2 { color: #b4c2f0;}
.s3 { color: #baacff;}
.s4 { color: #64d1a9;}
.s5 { color: #475f76;}
.s6 { color: #7fdaff;}
.s7 { color: #ff9668;}
</style>
</head>
<body bgcolor="#1c1e26">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
html5parser.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span><span class="s2">, </span><span class="s1">division</span><span class="s2">, </span><span class="s1">unicode_literals</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">six </span><span class="s0">import </span><span class="s1">with_metaclass</span><span class="s2">, </span><span class="s1">viewkeys</span>

<span class="s0">import </span><span class="s1">types</span>

<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">_inputstream</span>
<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">_tokenizer</span>

<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">treebuilders</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">treebuilders</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">Marker</span>

<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">_utils</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">constants </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">spaceCharacters</span><span class="s2">, </span><span class="s1">asciiUpper2Lower</span><span class="s2">,</span>
    <span class="s1">specialElements</span><span class="s2">, </span><span class="s1">headingElements</span><span class="s2">, </span><span class="s1">cdataElements</span><span class="s2">, </span><span class="s1">rcdataElements</span><span class="s2">,</span>
    <span class="s1">tokenTypes</span><span class="s2">, </span><span class="s1">tagTokenTypes</span><span class="s2">,</span>
    <span class="s1">namespaces</span><span class="s2">,</span>
    <span class="s1">htmlIntegrationPointElements</span><span class="s2">, </span><span class="s1">mathmlTextIntegrationPointElements</span><span class="s2">,</span>
    <span class="s1">adjustForeignAttributes </span><span class="s0">as </span><span class="s1">adjustForeignAttributesMap</span><span class="s2">,</span>
    <span class="s1">adjustMathMLAttributes</span><span class="s2">, </span><span class="s1">adjustSVGAttributes</span><span class="s2">,</span>
    <span class="s1">E</span><span class="s2">,</span>
    <span class="s1">_ReparseException</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">parse</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">, </span><span class="s1">treebuilder</span><span class="s3">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">namespaceHTMLElements</span><span class="s3">=</span><span class="s0">True</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;Parse an HTML document as a string or file-like object into a tree 
 
    :arg doc: the document to parse as a string or file-like object 
 
    :arg treebuilder: the treebuilder to use when parsing 
 
    :arg namespaceHTMLElements: whether or not to namespace HTML elements 
 
    :returns: parsed tree 
 
    Example: 
 
    &gt;&gt;&gt; from html5lib.html5parser import parse 
    &gt;&gt;&gt; parse('&lt;html&gt;&lt;body&gt;&lt;p&gt;This is a doc&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;') 
    &lt;Element u'{http://www.w3.org/1999/xhtml}html' at 0x7feac4909db0&gt; 
 
    &quot;&quot;&quot;</span>
    <span class="s1">tb </span><span class="s3">= </span><span class="s1">treebuilders</span><span class="s2">.</span><span class="s1">getTreeBuilder</span><span class="s2">(</span><span class="s1">treebuilder</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s1">HTMLParser</span><span class="s2">(</span><span class="s1">tb</span><span class="s2">, </span><span class="s1">namespaceHTMLElements</span><span class="s3">=</span><span class="s1">namespaceHTMLElements</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">p</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">parseFragment</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">, </span><span class="s1">container</span><span class="s3">=</span><span class="s4">&quot;div&quot;</span><span class="s2">, </span><span class="s1">treebuilder</span><span class="s3">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">namespaceHTMLElements</span><span class="s3">=</span><span class="s0">True</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;Parse an HTML fragment as a string or file-like object into a tree 
 
    :arg doc: the fragment to parse as a string or file-like object 
 
    :arg container: the container context to parse the fragment in 
 
    :arg treebuilder: the treebuilder to use when parsing 
 
    :arg namespaceHTMLElements: whether or not to namespace HTML elements 
 
    :returns: parsed tree 
 
    Example: 
 
    &gt;&gt;&gt; from html5lib.html5libparser import parseFragment 
    &gt;&gt;&gt; parseFragment('&lt;b&gt;this is a fragment&lt;/b&gt;') 
    &lt;Element u'DOCUMENT_FRAGMENT' at 0x7feac484b090&gt; 
 
    &quot;&quot;&quot;</span>
    <span class="s1">tb </span><span class="s3">= </span><span class="s1">treebuilders</span><span class="s2">.</span><span class="s1">getTreeBuilder</span><span class="s2">(</span><span class="s1">treebuilder</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s1">HTMLParser</span><span class="s2">(</span><span class="s1">tb</span><span class="s2">, </span><span class="s1">namespaceHTMLElements</span><span class="s3">=</span><span class="s1">namespaceHTMLElements</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">p</span><span class="s2">.</span><span class="s1">parseFragment</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">, </span><span class="s1">container</span><span class="s3">=</span><span class="s1">container</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">method_decorator_metaclass</span><span class="s2">(</span><span class="s1">function</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s0">class </span><span class="s1">Decorated</span><span class="s2">(</span><span class="s1">type</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">, </span><span class="s1">classname</span><span class="s2">, </span><span class="s1">bases</span><span class="s2">, </span><span class="s1">classDict</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">for </span><span class="s1">attributeName</span><span class="s2">, </span><span class="s1">attribute </span><span class="s0">in </span><span class="s1">classDict</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">attribute</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s1">attribute </span><span class="s3">= </span><span class="s1">function</span><span class="s2">(</span><span class="s1">attribute</span><span class="s2">)</span>

                <span class="s1">classDict</span><span class="s6">[</span><span class="s1">attributeName</span><span class="s6">] </span><span class="s3">= </span><span class="s1">attribute</span>
            <span class="s0">return </span><span class="s1">type</span><span class="s2">.</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">, </span><span class="s1">classname</span><span class="s2">, </span><span class="s1">bases</span><span class="s2">, </span><span class="s1">classDict</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">Decorated</span>


<span class="s0">class </span><span class="s1">HTMLParser</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;HTML parser 
 
    Generates a tree structure from a stream of (possibly malformed) HTML. 
 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tree</span><span class="s3">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">strict</span><span class="s3">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">namespaceHTMLElements</span><span class="s3">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">debug</span><span class="s3">=</span><span class="s0">False</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot; 
        :arg tree: a treebuilder class controlling the type of tree that will be 
            returned. Built in treebuilders can be accessed through 
            html5lib.treebuilders.getTreeBuilder(treeType) 
 
        :arg strict: raise an exception when a parse error is encountered 
 
        :arg namespaceHTMLElements: whether or not to namespace HTML elements 
 
        :arg debug: whether or not to enable debug mode which logs things 
 
        Example: 
 
        &gt;&gt;&gt; from html5lib.html5parser import HTMLParser 
        &gt;&gt;&gt; parser = HTMLParser()                     # generates parser with etree builder 
        &gt;&gt;&gt; parser = HTMLParser('lxml', strict=True)  # generates parser with lxml builder which is strict 
 
        &quot;&quot;&quot;</span>

        <span class="s5"># Raise an exception on the first error encountered</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">strict </span><span class="s3">= </span><span class="s1">strict</span>

        <span class="s0">if </span><span class="s1">tree </span><span class="s0">is None</span><span class="s3">:</span>
            <span class="s1">tree </span><span class="s3">= </span><span class="s1">treebuilders</span><span class="s2">.</span><span class="s1">getTreeBuilder</span><span class="s2">(</span><span class="s4">&quot;etree&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tree </span><span class="s3">= </span><span class="s1">tree</span><span class="s2">(</span><span class="s1">namespaceHTMLElements</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">errors </span><span class="s3">= </span><span class="s6">[]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">phases </span><span class="s3">= </span><span class="s6">{</span><span class="s1">name</span><span class="s3">: </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">) </span><span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">cls </span><span class="s0">in</span>
                       <span class="s1">getPhases</span><span class="s2">(</span><span class="s1">debug</span><span class="s2">).</span><span class="s1">items</span><span class="s2">()</span><span class="s6">}</span>

    <span class="s0">def </span><span class="s1">_parse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">, </span><span class="s1">innerHTML</span><span class="s3">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">container</span><span class="s3">=</span><span class="s4">&quot;div&quot;</span><span class="s2">, </span><span class="s1">scripting</span><span class="s3">=</span><span class="s0">False</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTMLMode </span><span class="s3">= </span><span class="s1">innerHTML</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">container </span><span class="s3">= </span><span class="s1">container</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scripting </span><span class="s3">= </span><span class="s1">scripting</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer </span><span class="s3">= </span><span class="s1">_tokenizer</span><span class="s2">.</span><span class="s1">HTMLTokenizer</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s1">parser</span><span class="s3">=</span><span class="s1">self</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>

        <span class="s0">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mainLoop</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">_ReparseException</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">mainLoop</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">reset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">firstStartTag </span><span class="s3">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">errors </span><span class="s3">= </span><span class="s6">[]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">log </span><span class="s3">= </span><span class="s6">[]  </span><span class="s5"># only used with debug mode</span>
        <span class="s5"># &quot;quirks&quot; / &quot;limited quirks&quot; / &quot;no quirks&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">compatMode </span><span class="s3">= </span><span class="s4">&quot;no quirks&quot;</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTMLMode</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML </span><span class="s0">in </span><span class="s1">cdataElements</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">rcdataState</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML </span><span class="s0">in </span><span class="s1">rcdataElements</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">rawtextState</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML </span><span class="s3">== </span><span class="s4">'plaintext'</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">plaintextState</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># state already is data state</span>
                <span class="s5"># self.tokenizer.state = self.tokenizer.dataState</span>
                <span class="s0">pass</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;beforeHtml&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">insertHtmlElement</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resetInsertionMode</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML </span><span class="s3">= </span><span class="s0">False  </span><span class="s5"># pylint:disable=redefined-variable-type</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;initial&quot;</span><span class="s6">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">lastPhase </span><span class="s3">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">beforeRCDataPhase </span><span class="s3">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">True</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">documentEncoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Name of the character encoding that was used to decode the input stream, or 
        :obj:`None` if that is not determined yet 
 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'tokenizer'</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return None</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s6">[</span><span class="s7">0</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name</span>

    <span class="s0">def </span><span class="s1">isHTMLIntegrationPoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">element</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">element</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;annotation-xml&quot; </span><span class="s0">and</span>
                <span class="s1">element</span><span class="s2">.</span><span class="s1">namespace </span><span class="s3">== </span><span class="s1">namespaces</span><span class="s6">[</span><span class="s4">&quot;mathml&quot;</span><span class="s6">]</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s4">&quot;encoding&quot; </span><span class="s0">in </span><span class="s1">element</span><span class="s2">.</span><span class="s1">attributes </span><span class="s0">and</span>
                    <span class="s1">element</span><span class="s2">.</span><span class="s1">attributes</span><span class="s6">[</span><span class="s4">&quot;encoding&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span>
                        <span class="s1">asciiUpper2Lower</span><span class="s2">) </span><span class="s0">in</span>
                    <span class="s2">(</span><span class="s4">&quot;text/html&quot;</span><span class="s2">, </span><span class="s4">&quot;application/xhtml+xml&quot;</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">element</span><span class="s2">.</span><span class="s1">namespace</span><span class="s2">, </span><span class="s1">element</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">in </span><span class="s1">htmlIntegrationPointElements</span>

    <span class="s0">def </span><span class="s1">isMathMLTextIntegrationPoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">element</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">element</span><span class="s2">.</span><span class="s1">namespace</span><span class="s2">, </span><span class="s1">element</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">in </span><span class="s1">mathmlTextIntegrationPointElements</span>

    <span class="s0">def </span><span class="s1">mainLoop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">CharactersToken </span><span class="s3">= </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;Characters&quot;</span><span class="s6">]</span>
        <span class="s1">SpaceCharactersToken </span><span class="s3">= </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;SpaceCharacters&quot;</span><span class="s6">]</span>
        <span class="s1">StartTagToken </span><span class="s3">= </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;StartTag&quot;</span><span class="s6">]</span>
        <span class="s1">EndTagToken </span><span class="s3">= </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;EndTag&quot;</span><span class="s6">]</span>
        <span class="s1">CommentToken </span><span class="s3">= </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;Comment&quot;</span><span class="s6">]</span>
        <span class="s1">DoctypeToken </span><span class="s3">= </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;Doctype&quot;</span><span class="s6">]</span>
        <span class="s1">ParseErrorToken </span><span class="s3">= </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;ParseError&quot;</span><span class="s6">]</span>

        <span class="s0">for </span><span class="s1">token </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s3">:</span>
            <span class="s1">prev_token </span><span class="s3">= </span><span class="s0">None</span>
            <span class="s1">new_token </span><span class="s3">= </span><span class="s1">token</span>
            <span class="s0">while </span><span class="s1">new_token </span><span class="s0">is not None</span><span class="s3">:</span>
                <span class="s1">prev_token </span><span class="s3">= </span><span class="s1">new_token</span>
                <span class="s1">currentNode </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">] </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements </span><span class="s0">else None</span>
                <span class="s1">currentNodeNamespace </span><span class="s3">= </span><span class="s1">currentNode</span><span class="s2">.</span><span class="s1">namespace </span><span class="s0">if </span><span class="s1">currentNode </span><span class="s0">else None</span>
                <span class="s1">currentNodeName </span><span class="s3">= </span><span class="s1">currentNode</span><span class="s2">.</span><span class="s1">name </span><span class="s0">if </span><span class="s1">currentNode </span><span class="s0">else None</span>

                <span class="s1">type </span><span class="s3">= </span><span class="s1">new_token</span><span class="s6">[</span><span class="s4">&quot;type&quot;</span><span class="s6">]</span>

                <span class="s0">if </span><span class="s1">type </span><span class="s3">== </span><span class="s1">ParseErrorToken</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s1">new_token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s1">new_token</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;datavars&quot;</span><span class="s2">, </span><span class="s6">{}</span><span class="s2">))</span>
                    <span class="s1">new_token </span><span class="s3">= </span><span class="s0">None</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s0">if </span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">) </span><span class="s3">== </span><span class="s7">0 </span><span class="s0">or</span>
                        <span class="s1">currentNodeNamespace </span><span class="s3">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">defaultNamespace </span><span class="s0">or</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">isMathMLTextIntegrationPoint</span><span class="s2">(</span><span class="s1">currentNode</span><span class="s2">) </span><span class="s0">and</span>
                         <span class="s2">((</span><span class="s1">type </span><span class="s3">== </span><span class="s1">StartTagToken </span><span class="s0">and</span>
                           <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s0">not in </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s6">[</span><span class="s4">&quot;mglyph&quot;</span><span class="s2">, </span><span class="s4">&quot;malignmark&quot;</span><span class="s6">]</span><span class="s2">)) </span><span class="s0">or</span>
                          <span class="s1">type </span><span class="s0">in </span><span class="s2">(</span><span class="s1">CharactersToken</span><span class="s2">, </span><span class="s1">SpaceCharactersToken</span><span class="s2">))) </span><span class="s0">or</span>
                        <span class="s2">(</span><span class="s1">currentNodeNamespace </span><span class="s3">== </span><span class="s1">namespaces</span><span class="s6">[</span><span class="s4">&quot;mathml&quot;</span><span class="s6">] </span><span class="s0">and</span>
                         <span class="s1">currentNodeName </span><span class="s3">== </span><span class="s4">&quot;annotation-xml&quot; </span><span class="s0">and</span>
                         <span class="s1">type </span><span class="s3">== </span><span class="s1">StartTagToken </span><span class="s0">and</span>
                         <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;svg&quot;</span><span class="s2">) </span><span class="s0">or</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">isHTMLIntegrationPoint</span><span class="s2">(</span><span class="s1">currentNode</span><span class="s2">) </span><span class="s0">and</span>
                         <span class="s1">type </span><span class="s0">in </span><span class="s2">(</span><span class="s1">StartTagToken</span><span class="s2">, </span><span class="s1">CharactersToken</span><span class="s2">, </span><span class="s1">SpaceCharactersToken</span><span class="s2">)))</span><span class="s3">:</span>
                        <span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span>
                    <span class="s0">else</span><span class="s3">:</span>
                        <span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inForeignContent&quot;</span><span class="s6">]</span>

                    <span class="s0">if </span><span class="s1">type </span><span class="s3">== </span><span class="s1">CharactersToken</span><span class="s3">:</span>
                        <span class="s1">new_token </span><span class="s3">= </span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">new_token</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">type </span><span class="s3">== </span><span class="s1">SpaceCharactersToken</span><span class="s3">:</span>
                        <span class="s1">new_token </span><span class="s3">= </span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">new_token</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">type </span><span class="s3">== </span><span class="s1">StartTagToken</span><span class="s3">:</span>
                        <span class="s1">new_token </span><span class="s3">= </span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">new_token</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">type </span><span class="s3">== </span><span class="s1">EndTagToken</span><span class="s3">:</span>
                        <span class="s1">new_token </span><span class="s3">= </span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">new_token</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">type </span><span class="s3">== </span><span class="s1">CommentToken</span><span class="s3">:</span>
                        <span class="s1">new_token </span><span class="s3">= </span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">new_token</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">type </span><span class="s3">== </span><span class="s1">DoctypeToken</span><span class="s3">:</span>
                        <span class="s1">new_token </span><span class="s3">= </span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processDoctype</span><span class="s2">(</span><span class="s1">new_token</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s2">(</span><span class="s1">type </span><span class="s3">== </span><span class="s1">StartTagToken </span><span class="s0">and </span><span class="s1">prev_token</span><span class="s6">[</span><span class="s4">&quot;selfClosing&quot;</span><span class="s6">] </span><span class="s0">and</span>
                    <span class="s0">not </span><span class="s1">prev_token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">]</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;non-void-element-with-trailing-solidus&quot;</span><span class="s2">,</span>
                                <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">prev_token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s5"># When the loop finishes it's EOF</span>
        <span class="s1">reprocess </span><span class="s3">= </span><span class="s0">True</span>
        <span class="s1">phases </span><span class="s3">= </span><span class="s6">[]</span>
        <span class="s0">while </span><span class="s1">reprocess</span><span class="s3">:</span>
            <span class="s1">phases</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">)</span>
            <span class="s1">reprocess </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEOF</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">reprocess</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s0">not in </span><span class="s1">phases</span>

    <span class="s0">def </span><span class="s1">parse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Parse a HTML document into a well-formed tree 
 
        :arg stream: a file-like object or string containing the HTML to be parsed 
 
            The optional encoding parameter must be a string that indicates 
            the encoding.  If specified, that encoding will be used, 
            regardless of any BOM or later declaration (such as in a meta 
            element). 
 
        :arg scripting: treat noscript elements as if JavaScript was turned on 
 
        :returns: parsed tree 
 
        Example: 
 
        &gt;&gt;&gt; from html5lib.html5parser import HTMLParser 
        &gt;&gt;&gt; parser = HTMLParser() 
        &gt;&gt;&gt; parser.parse('&lt;html&gt;&lt;body&gt;&lt;p&gt;This is a doc&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;') 
        &lt;Element u'{http://www.w3.org/1999/xhtml}html' at 0x7feac4909db0&gt; 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_parse</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">getDocument</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">parseFragment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Parse a HTML fragment into a well-formed tree fragment 
 
        :arg container: name of the element we're setting the innerHTML 
            property if set to None, default to 'div' 
 
        :arg stream: a file-like object or string containing the HTML to be parsed 
 
            The optional encoding parameter must be a string that indicates 
            the encoding.  If specified, that encoding will be used, 
            regardless of any BOM or later declaration (such as in a meta 
            element) 
 
        :arg scripting: treat noscript elements as if JavaScript was turned on 
 
        :returns: parsed tree 
 
        Example: 
 
        &gt;&gt;&gt; from html5lib.html5libparser import HTMLParser 
        &gt;&gt;&gt; parser = HTMLParser() 
        &gt;&gt;&gt; parser.parseFragment('&lt;b&gt;this is a fragment&lt;/b&gt;') 
        &lt;Element u'DOCUMENT_FRAGMENT' at 0x7feac484b090&gt; 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_parse</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">getFragment</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">parseError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">errorcode</span><span class="s3">=</span><span class="s4">&quot;XXX-undefined-error&quot;</span><span class="s2">, </span><span class="s1">datavars</span><span class="s3">=</span><span class="s0">None</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># XXX The idea is to make errorcode mandatory.</span>
        <span class="s0">if </span><span class="s1">datavars </span><span class="s0">is None</span><span class="s3">:</span>
            <span class="s1">datavars </span><span class="s3">= </span><span class="s6">{}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">position</span><span class="s2">(), </span><span class="s1">errorcode</span><span class="s2">, </span><span class="s1">datavars</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">strict</span><span class="s3">:</span>
            <span class="s0">raise </span><span class="s1">ParseError</span><span class="s2">(</span><span class="s1">E</span><span class="s6">[</span><span class="s1">errorcode</span><span class="s6">] </span><span class="s3">% </span><span class="s1">datavars</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">adjustMathMLAttributes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">adjust_attributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">adjustMathMLAttributes</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">adjustSVGAttributes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">adjust_attributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">adjustSVGAttributes</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">adjustForeignAttributes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">adjust_attributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">adjustForeignAttributesMap</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">reparseTokenNormal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># pylint:disable=unused-argument</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">resetInsertionMode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># The name of this method is mostly historical. (It's also used in the</span>
        <span class="s5"># specification.)</span>
        <span class="s1">last </span><span class="s3">= </span><span class="s0">False</span>
        <span class="s1">newModes </span><span class="s3">= </span><span class="s6">{</span>
            <span class="s4">&quot;select&quot;</span><span class="s3">: </span><span class="s4">&quot;inSelect&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;td&quot;</span><span class="s3">: </span><span class="s4">&quot;inCell&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;th&quot;</span><span class="s3">: </span><span class="s4">&quot;inCell&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;tr&quot;</span><span class="s3">: </span><span class="s4">&quot;inRow&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;tbody&quot;</span><span class="s3">: </span><span class="s4">&quot;inTableBody&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;thead&quot;</span><span class="s3">: </span><span class="s4">&quot;inTableBody&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;tfoot&quot;</span><span class="s3">: </span><span class="s4">&quot;inTableBody&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;caption&quot;</span><span class="s3">: </span><span class="s4">&quot;inCaption&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;colgroup&quot;</span><span class="s3">: </span><span class="s4">&quot;inColumnGroup&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;table&quot;</span><span class="s3">: </span><span class="s4">&quot;inTable&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;head&quot;</span><span class="s3">: </span><span class="s4">&quot;inBody&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;body&quot;</span><span class="s3">: </span><span class="s4">&quot;inBody&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;frameset&quot;</span><span class="s3">: </span><span class="s4">&quot;inFrameset&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;html&quot;</span><span class="s3">: </span><span class="s4">&quot;beforeHead&quot;</span>
        <span class="s6">}</span>
        <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">::-</span><span class="s7">1</span><span class="s6">]</span><span class="s3">:</span>
            <span class="s1">nodeName </span><span class="s3">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s1">new_phase </span><span class="s3">= </span><span class="s0">None</span>
            <span class="s0">if </span><span class="s1">node </span><span class="s3">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">0</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">last </span><span class="s3">= </span><span class="s0">True</span>
                <span class="s1">nodeName </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML</span>
            <span class="s5"># Check for conditions that should only happen in the innerHTML</span>
            <span class="s5"># case</span>
            <span class="s0">if </span><span class="s1">nodeName </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">innerHTML</span>

            <span class="s0">if not </span><span class="s1">last </span><span class="s0">and </span><span class="s1">node</span><span class="s2">.</span><span class="s1">namespace </span><span class="s3">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">defaultNamespace</span><span class="s3">:</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">nodeName </span><span class="s0">in </span><span class="s1">newModes</span><span class="s3">:</span>
                <span class="s1">new_phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s1">newModes</span><span class="s6">[</span><span class="s1">nodeName</span><span class="s6">]]</span>
                <span class="s0">break</span>
            <span class="s0">elif </span><span class="s1">last</span><span class="s3">:</span>
                <span class="s1">new_phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
                <span class="s0">break</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">new_phase</span>

    <span class="s0">def </span><span class="s1">parseRCDataRawtext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">, </span><span class="s1">contentType</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># Generic RCDATA/RAWTEXT Parsing algorithm</span>
        <span class="s0">assert </span><span class="s1">contentType </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;RAWTEXT&quot;</span><span class="s2">, </span><span class="s4">&quot;RCDATA&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">contentType </span><span class="s3">== </span><span class="s4">&quot;RAWTEXT&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">rawtextState</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">rcdataState</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">originalPhase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phase</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;text&quot;</span><span class="s6">]</span>


<span class="s3">@</span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">memoize</span>
<span class="s0">def </span><span class="s1">getPhases</span><span class="s2">(</span><span class="s1">debug</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s0">def </span><span class="s1">log</span><span class="s2">(</span><span class="s1">function</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Logger that records which phase processes each token&quot;&quot;&quot;</span>
        <span class="s1">type_names </span><span class="s3">= </span><span class="s6">{</span><span class="s1">value</span><span class="s3">: </span><span class="s1">key </span><span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">tokenTypes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span><span class="s6">}</span>

        <span class="s0">def </span><span class="s1">wrapped</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">function</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;process&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) </span><span class="s3">&gt; </span><span class="s7">0</span><span class="s3">:</span>
                <span class="s1">token </span><span class="s3">= </span><span class="s1">args</span><span class="s6">[</span><span class="s7">0</span><span class="s6">]</span>
                <span class="s1">info </span><span class="s3">= </span><span class="s6">{</span><span class="s4">&quot;type&quot;</span><span class="s3">: </span><span class="s1">type_names</span><span class="s6">[</span><span class="s1">token</span><span class="s6">[</span><span class="s4">'type'</span><span class="s6">]]}</span>
                <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">'type'</span><span class="s6">] </span><span class="s0">in </span><span class="s1">tagTokenTypes</span><span class="s3">:</span>
                    <span class="s1">info</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">'name'</span><span class="s6">]</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">log</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                        <span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                        <span class="s1">function</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                        <span class="s1">info</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">wrapped</span>

    <span class="s0">def </span><span class="s1">getMetaclass</span><span class="s2">(</span><span class="s1">use_metaclass</span><span class="s2">, </span><span class="s1">metaclass_func</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">if </span><span class="s1">use_metaclass</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">method_decorator_metaclass</span><span class="s2">(</span><span class="s1">metaclass_func</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">type</span>

    <span class="s5"># pylint:disable=unused-argument</span>
    <span class="s0">class </span><span class="s1">Phase</span><span class="s2">(</span><span class="s1">with_metaclass</span><span class="s2">(</span><span class="s1">getMetaclass</span><span class="s2">(</span><span class="s1">debug</span><span class="s2">, </span><span class="s1">log</span><span class="s2">)))</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Base class for helper object that implements each phase of processing 
        &quot;&quot;&quot;</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s2">(</span><span class="s4">&quot;parser&quot;</span><span class="s2">, </span><span class="s4">&quot;tree&quot;</span><span class="s2">, </span><span class="s4">&quot;__startTagCache&quot;</span><span class="s2">, </span><span class="s4">&quot;__endTagCache&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">tree</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser </span><span class="s3">= </span><span class="s1">parser</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree </span><span class="s3">= </span><span class="s1">tree</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__startTagCache </span><span class="s3">= </span><span class="s6">{}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__endTagCache </span><span class="s3">= </span><span class="s6">{}</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># For most phases the following is correct. Where it's not it will be</span>
            <span class="s5"># overridden.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertComment</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processDoctype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-doctype&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Note the caching is done here rather than BoundMethodDispatcher as doing it there</span>
            <span class="s5"># requires a circular reference to the Phase, and this ends up with a significant</span>
            <span class="s5"># (CPython 2.7, 3.8) GC cost when parsing many short inputs</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span>
            <span class="s5"># In Py2, using `in` is quicker in general than try/except KeyError</span>
            <span class="s5"># In Py3, `in` is quicker when there are few cache hits (typically short inputs)</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__startTagCache</span><span class="s3">:</span>
                <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__startTagCache</span><span class="s6">[</span><span class="s1">name</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__startTagCache</span><span class="s6">[</span><span class="s1">name</span><span class="s6">] </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">startTagHandler</span><span class="s6">[</span><span class="s1">name</span><span class="s6">]</span>
                <span class="s5"># bound the cache size in case we get loads of unknown tags</span>
                <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__startTagCache</span><span class="s2">) </span><span class="s3">&gt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">startTagHandler</span><span class="s2">) </span><span class="s3">* </span><span class="s7">1.1</span><span class="s3">:</span>
                    <span class="s5"># this makes the eviction policy random on Py &lt; 3.7 and FIFO &gt;= 3.7</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__startTagCache</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__startTagCache</span><span class="s2">)))</span>
            <span class="s0">return </span><span class="s1">func</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">firstStartTag </span><span class="s0">and </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;non-html-root&quot;</span><span class="s2">)</span>
            <span class="s5"># XXX Need a check here to see if the first start tag token emitted is</span>
            <span class="s5"># this token... If it's not, invoke self.parser.parseError().</span>
            <span class="s0">for </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">attr </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">0</span><span class="s6">]</span><span class="s2">.</span><span class="s1">attributes</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">0</span><span class="s6">]</span><span class="s2">.</span><span class="s1">attributes</span><span class="s6">[</span><span class="s1">attr</span><span class="s6">] </span><span class="s3">= </span><span class="s1">value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">firstStartTag </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Note the caching is done here rather than BoundMethodDispatcher as doing it there</span>
            <span class="s5"># requires a circular reference to the Phase, and this ends up with a significant</span>
            <span class="s5"># (CPython 2.7, 3.8) GC cost when parsing many short inputs</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span>
            <span class="s5"># In Py2, using `in` is quicker in general than try/except KeyError</span>
            <span class="s5"># In Py3, `in` is quicker when there are few cache hits (typically short inputs)</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__endTagCache</span><span class="s3">:</span>
                <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__endTagCache</span><span class="s6">[</span><span class="s1">name</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__endTagCache</span><span class="s6">[</span><span class="s1">name</span><span class="s6">] </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">endTagHandler</span><span class="s6">[</span><span class="s1">name</span><span class="s6">]</span>
                <span class="s5"># bound the cache size in case we get loads of unknown tags</span>
                <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__endTagCache</span><span class="s2">) </span><span class="s3">&gt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">endTagHandler</span><span class="s2">) </span><span class="s3">* </span><span class="s7">1.1</span><span class="s3">:</span>
                    <span class="s5"># this makes the eviction policy random on Py &lt; 3.7 and FIFO &gt;= 3.7</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">__endTagCache</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__endTagCache</span><span class="s2">)))</span>
            <span class="s0">return </span><span class="s1">func</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

    <span class="s0">class </span><span class="s1">InitialPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertComment</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">document</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processDoctype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span>
            <span class="s1">publicId </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;publicId&quot;</span><span class="s6">]</span>
            <span class="s1">systemId </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;systemId&quot;</span><span class="s6">]</span>
            <span class="s1">correct </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;correct&quot;</span><span class="s6">]</span>

            <span class="s0">if </span><span class="s2">(</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;html&quot; </span><span class="s0">or </span><span class="s1">publicId </span><span class="s0">is not None or</span>
                    <span class="s1">systemId </span><span class="s0">is not None and </span><span class="s1">systemId </span><span class="s3">!= </span><span class="s4">&quot;about:legacy-compat&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unknown-doctype&quot;</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">publicId </span><span class="s0">is None</span><span class="s3">:</span>
                <span class="s1">publicId </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertDoctype</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">publicId </span><span class="s3">!= </span><span class="s4">&quot;&quot;</span><span class="s3">:</span>
                <span class="s1">publicId </span><span class="s3">= </span><span class="s1">publicId</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">asciiUpper2Lower</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s2">(</span><span class="s0">not </span><span class="s1">correct </span><span class="s0">or </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">!= </span><span class="s4">&quot;html&quot; </span><span class="s0">or</span>
                    <span class="s1">publicId</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span>
                        <span class="s2">(</span><span class="s4">&quot;+//silmaril//dtd html pro v0r11 19970101//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//advasoft ltd//dtd html 3.0 aswedit + extensions//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//as//dtd html 3.0 aswedit + extensions//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 2.0 level 1//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 2.0 level 2//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 2.0 strict level 1//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 2.0 strict level 2//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 2.0 strict//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 2.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 2.1e//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 3.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 3.2 final//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 3.2//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html 3//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html level 0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html level 1//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html level 2//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html level 3//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html strict level 0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html strict level 1//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html strict level 2//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html strict level 3//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html strict//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//ietf//dtd html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//metrius//dtd metrius presentational//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//microsoft//dtd internet explorer 2.0 html strict//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//microsoft//dtd internet explorer 2.0 html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//microsoft//dtd internet explorer 2.0 tables//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//microsoft//dtd internet explorer 3.0 html strict//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//microsoft//dtd internet explorer 3.0 html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//microsoft//dtd internet explorer 3.0 tables//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//netscape comm. corp.//dtd html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//netscape comm. corp.//dtd strict html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//o'reilly and associates//dtd html 2.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//o'reilly and associates//dtd html extended 1.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//o'reilly and associates//dtd html extended relaxed 1.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//spyglass//dtd html 2.0 extended//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//sq//dtd html 2.0 hotmetal + extensions//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//sun microsystems corp.//dtd hotjava html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//sun microsystems corp.//dtd hotjava strict html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 3 1995-03-24//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 3.2 draft//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 3.2 final//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 3.2//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 3.2s draft//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 4.0 frameset//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 4.0 transitional//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html experimental 19960712//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html experimental 970421//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd w3 html//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3o//dtd w3 html 3.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//webtechs//dtd mozilla html 2.0//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//webtechs//dtd mozilla html//&quot;</span><span class="s2">)) </span><span class="s0">or</span>
                    <span class="s1">publicId </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;-//w3o//dtd w3 html strict 3.0//en//&quot;</span><span class="s2">,</span>
                                 <span class="s4">&quot;-/w3c/dtd html 4.0 transitional/en&quot;</span><span class="s2">,</span>
                                 <span class="s4">&quot;html&quot;</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s1">publicId</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span>
                        <span class="s2">(</span><span class="s4">&quot;-//w3c//dtd html 4.01 frameset//&quot;</span><span class="s2">,</span>
                         <span class="s4">&quot;-//w3c//dtd html 4.01 transitional//&quot;</span><span class="s2">)) </span><span class="s0">and</span>
                    <span class="s1">systemId </span><span class="s0">is None or</span>
                    <span class="s1">systemId </span><span class="s0">and </span><span class="s1">systemId</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s3">== </span><span class="s4">&quot;http://www.ibm.com/data/dtd/v11/ibmxhtml1-transitional.dtd&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">compatMode </span><span class="s3">= </span><span class="s4">&quot;quirks&quot;</span>
            <span class="s0">elif </span><span class="s2">(</span><span class="s1">publicId</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span>
                    <span class="s2">(</span><span class="s4">&quot;-//w3c//dtd xhtml 1.0 frameset//&quot;</span><span class="s2">,</span>
                     <span class="s4">&quot;-//w3c//dtd xhtml 1.0 transitional//&quot;</span><span class="s2">)) </span><span class="s0">or</span>
                  <span class="s1">publicId</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span>
                      <span class="s2">(</span><span class="s4">&quot;-//w3c//dtd html 4.01 frameset//&quot;</span><span class="s2">,</span>
                       <span class="s4">&quot;-//w3c//dtd html 4.01 transitional//&quot;</span><span class="s2">)) </span><span class="s0">and</span>
                  <span class="s1">systemId </span><span class="s0">is not None</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">compatMode </span><span class="s3">= </span><span class="s4">&quot;limited quirks&quot;</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;beforeHtml&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">anythingElse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">compatMode </span><span class="s3">= </span><span class="s4">&quot;quirks&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;beforeHtml&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-doctype-but-got-chars&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-doctype-but-got-start-tag&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-doctype-but-got-end-tag&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-doctype-but-got-eof&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return True</span>

    <span class="s0">class </span><span class="s1">BeforeHtmlPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s5"># helper methods</span>
        <span class="s0">def </span><span class="s1">insertHtmlElement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertRoot</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;beforeHead&quot;</span><span class="s6">]</span>

        <span class="s5"># other</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">insertHtmlElement</span><span class="s2">()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertComment</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">document</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">insertHtmlElement</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">firstStartTag </span><span class="s3">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">insertHtmlElement</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s0">not in </span><span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;br&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-before-html&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">insertHtmlElement</span><span class="s2">()</span>
                <span class="s0">return </span><span class="s1">token</span>

    <span class="s0">class </span><span class="s1">BeforeHeadPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagHead</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagHead</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagHead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">headPointer </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagHead</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagImplyHead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagHead</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;end-tag-after-implied-root&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s1">startTagHead</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">((</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;br&quot;</span><span class="s2">), </span><span class="s1">endTagImplyHead</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InHeadPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s5"># the real thing</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagHead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;two-heads-are-not-better-than-one&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagBaseLinkCommand</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagMeta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>

            <span class="s1">attributes </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">charEncoding</span><span class="s6">[</span><span class="s7">1</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;tentative&quot;</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s4">&quot;charset&quot; </span><span class="s0">in </span><span class="s1">attributes</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">changeEncoding</span><span class="s2">(</span><span class="s1">attributes</span><span class="s6">[</span><span class="s4">&quot;charset&quot;</span><span class="s6">]</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s2">(</span><span class="s4">&quot;content&quot; </span><span class="s0">in </span><span class="s1">attributes </span><span class="s0">and</span>
                      <span class="s4">&quot;http-equiv&quot; </span><span class="s0">in </span><span class="s1">attributes </span><span class="s0">and</span>
                      <span class="s1">attributes</span><span class="s6">[</span><span class="s4">&quot;http-equiv&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s3">== </span><span class="s4">&quot;content-type&quot;</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s5"># Encoding it as UTF-8 here is a hack, as really we should pass</span>
                    <span class="s5"># the abstract Unicode string, and just use the</span>
                    <span class="s5"># ContentAttrParser on that, but using UTF-8 allows all chars</span>
                    <span class="s5"># to be encoded and as a ASCII-superset works.</span>
                    <span class="s1">data </span><span class="s3">= </span><span class="s1">_inputstream</span><span class="s2">.</span><span class="s1">EncodingBytes</span><span class="s2">(</span><span class="s1">attributes</span><span class="s6">[</span><span class="s4">&quot;content&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">))</span>
                    <span class="s1">parser </span><span class="s3">= </span><span class="s1">_inputstream</span><span class="s2">.</span><span class="s1">ContentAttrParser</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                    <span class="s1">codec </span><span class="s3">= </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">()</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">changeEncoding</span><span class="s2">(</span><span class="s1">codec</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTitle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseRCDataRawtext</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s4">&quot;RCDATA&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagNoFramesStyle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Need to decide whether to implement the scripting-disabled case</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseRCDataRawtext</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s4">&quot;RAWTEXT&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagNoscript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">scripting</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseRCDataRawtext</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s4">&quot;RAWTEXT&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHeadNoscript&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagScript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">scriptDataState</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">originalPhase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;text&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagHead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;Expected head got %s&quot; </span><span class="s3">% </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;afterHead&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagHtmlBodyBr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">anythingElse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagHead</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">))</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s1">startTagTitle</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;noframes&quot;</span><span class="s2">, </span><span class="s4">&quot;style&quot;</span><span class="s2">), </span><span class="s1">startTagNoFramesStyle</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;noscript&quot;</span><span class="s2">, </span><span class="s1">startTagNoscript</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;script&quot;</span><span class="s2">, </span><span class="s1">startTagScript</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;base&quot;</span><span class="s2">, </span><span class="s4">&quot;basefont&quot;</span><span class="s2">, </span><span class="s4">&quot;bgsound&quot;</span><span class="s2">, </span><span class="s4">&quot;command&quot;</span><span class="s2">, </span><span class="s4">&quot;link&quot;</span><span class="s2">),</span>
             <span class="s1">startTagBaseLinkCommand</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;meta&quot;</span><span class="s2">, </span><span class="s1">startTagMeta</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s1">startTagHead</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s1">endTagHead</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;br&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;body&quot;</span><span class="s2">), </span><span class="s1">endTagHtmlBodyBr</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InHeadNoscriptPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;eof-in-head-noscript&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;char-in-head-noscript&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagBaseLinkCommand</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagHeadNoscript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-inhead-noscript-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagNoscript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;noscript&quot;</span><span class="s2">, </span><span class="s4">&quot;Expected noscript got %s&quot; </span><span class="s3">% </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagBr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-inhead-noscript-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">anythingElse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Caller must raise parse error first!</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagNoscript</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;noscript&quot;</span><span class="s2">))</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;basefont&quot;</span><span class="s2">, </span><span class="s4">&quot;bgsound&quot;</span><span class="s2">, </span><span class="s4">&quot;link&quot;</span><span class="s2">, </span><span class="s4">&quot;meta&quot;</span><span class="s2">, </span><span class="s4">&quot;noframes&quot;</span><span class="s2">, </span><span class="s4">&quot;style&quot;</span><span class="s2">), </span><span class="s1">startTagBaseLinkCommand</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;noscript&quot;</span><span class="s2">), </span><span class="s1">startTagHeadNoscript</span><span class="s2">),</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;noscript&quot;</span><span class="s2">, </span><span class="s1">endTagNoscript</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;br&quot;</span><span class="s2">, </span><span class="s1">endTagBr</span><span class="s2">),</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">AfterHeadPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagBody</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagFrameset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inFrameset&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagFromHead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-out-of-my-head&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">headPointer</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">::-</span><span class="s7">1</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;head&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
                    <span class="s0">break</span>

        <span class="s0">def </span><span class="s1">startTagHead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagHtmlBodyBr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anythingElse</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">anythingElse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">True</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s1">startTagBody</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;frameset&quot;</span><span class="s2">, </span><span class="s1">startTagFrameset</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;base&quot;</span><span class="s2">, </span><span class="s4">&quot;basefont&quot;</span><span class="s2">, </span><span class="s4">&quot;bgsound&quot;</span><span class="s2">, </span><span class="s4">&quot;link&quot;</span><span class="s2">, </span><span class="s4">&quot;meta&quot;</span><span class="s2">, </span><span class="s4">&quot;noframes&quot;</span><span class="s2">, </span><span class="s4">&quot;script&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;style&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">),</span>
             <span class="s1">startTagFromHead</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s1">startTagHead</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>
        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span><span class="s2">((</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;br&quot;</span><span class="s2">),</span>
                                                  <span class="s1">endTagHtmlBodyBr</span><span class="s2">)</span><span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InBodyPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#parsing-main-inbody</span>
        <span class="s5"># the really-really-really-very crazy mode</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s2">(</span><span class="s4">&quot;processSpaceCharacters&quot;</span><span class="s2">,)</span>

        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">InBodyPhase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s5"># Set this to the default handler</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharacters </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharactersNonPre</span>

        <span class="s0">def </span><span class="s1">isMatchingFormattingElement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node1</span><span class="s2">, </span><span class="s1">node2</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">node1</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">node2</span><span class="s2">.</span><span class="s1">name </span><span class="s0">and</span>
                    <span class="s1">node1</span><span class="s2">.</span><span class="s1">namespace </span><span class="s3">== </span><span class="s1">node2</span><span class="s2">.</span><span class="s1">namespace </span><span class="s0">and</span>
                    <span class="s1">node1</span><span class="s2">.</span><span class="s1">attributes </span><span class="s3">== </span><span class="s1">node2</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">)</span>

        <span class="s5"># helper</span>
        <span class="s0">def </span><span class="s1">addFormattingElement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">element </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span>

            <span class="s1">matchingElements </span><span class="s3">= </span><span class="s6">[]</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s6">[</span><span class="s3">::-</span><span class="s7">1</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">node </span><span class="s0">is </span><span class="s1">Marker</span><span class="s3">:</span>
                    <span class="s0">break</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">isMatchingFormattingElement</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">element</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s1">matchingElements</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">matchingElements</span><span class="s2">) </span><span class="s3">&lt;= </span><span class="s7">3</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">matchingElements</span><span class="s2">) </span><span class="s3">== </span><span class="s7">3</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">matchingElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">element</span><span class="s2">)</span>

        <span class="s5"># the real deal</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">allowed_elements </span><span class="s3">= </span><span class="s1">frozenset</span><span class="s2">((</span><span class="s4">&quot;dd&quot;</span><span class="s2">, </span><span class="s4">&quot;dt&quot;</span><span class="s2">, </span><span class="s4">&quot;li&quot;</span><span class="s2">, </span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">,</span>
                                          <span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s4">&quot;body&quot;</span><span class="s2">,</span>
                                          <span class="s4">&quot;html&quot;</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">::-</span><span class="s7">1</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">allowed_elements</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-closing-tag-but-got-eof&quot;</span><span class="s2">)</span>
                    <span class="s0">break</span>
            <span class="s5"># Stop parsing</span>

        <span class="s0">def </span><span class="s1">processSpaceCharactersDropNewline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Sometimes (start of &lt;pre&gt;, &lt;listing&gt;, and &lt;textarea&gt; blocks) we</span>
            <span class="s5"># want to drop leading newlines</span>
            <span class="s1">data </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharacters </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharactersNonPre</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;\n&quot;</span><span class="s2">) </span><span class="s0">and</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;pre&quot;</span><span class="s2">, </span><span class="s4">&quot;listing&quot;</span><span class="s2">, </span><span class="s4">&quot;textarea&quot;</span><span class="s2">) </span><span class="s0">and</span>
                    <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">hasContent</span><span class="s2">())</span><span class="s3">:</span>
                <span class="s1">data </span><span class="s3">= </span><span class="s1">data</span><span class="s6">[</span><span class="s7">1</span><span class="s3">:</span><span class="s6">]</span>
            <span class="s0">if </span><span class="s1">data</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;\u0000&quot;</span><span class="s3">:</span>
                <span class="s5"># The tokenizer should always emit null on its own</span>
                <span class="s0">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">)</span>
            <span class="s5"># This must be bad for performance</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s0">and</span>
                <span class="s1">any</span><span class="s2">(</span><span class="s6">[</span><span class="s1">char </span><span class="s0">not in </span><span class="s1">spaceCharacters</span>
                     <span class="s0">for </span><span class="s1">char </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]]</span><span class="s2">))</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">processSpaceCharactersNonPre</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagProcessInHead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagBody</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;body&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">) </span><span class="s3">== </span><span class="s7">1 </span><span class="s0">or</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;body&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
                <span class="s0">for </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span><span class="s3">:</span>
                    <span class="s0">if </span><span class="s1">attr </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">attributes</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">attributes</span><span class="s6">[</span><span class="s1">attr</span><span class="s6">] </span><span class="s3">= </span><span class="s1">value</span>

        <span class="s0">def </span><span class="s1">startTagFrameset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;frameset&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">) </span><span class="s3">== </span><span class="s7">1 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;body&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
            <span class="s0">elif not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK</span><span class="s3">:</span>
                <span class="s0">pass</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">parent</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">removeChild</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">1</span><span class="s6">]</span><span class="s2">)</span>
                <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inFrameset&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagCloseP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagPreListing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharacters </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharactersDropNewline</span>

        <span class="s0">def </span><span class="s1">startTagForm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">formPointer</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;form&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">formPointer </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagListItem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>

            <span class="s1">stopNamesMap </span><span class="s3">= </span><span class="s6">{</span><span class="s4">&quot;li&quot;</span><span class="s3">: </span><span class="s6">[</span><span class="s4">&quot;li&quot;</span><span class="s6">]</span><span class="s2">,</span>
                            <span class="s4">&quot;dt&quot;</span><span class="s3">: </span><span class="s6">[</span><span class="s4">&quot;dt&quot;</span><span class="s2">, </span><span class="s4">&quot;dd&quot;</span><span class="s6">]</span><span class="s2">,</span>
                            <span class="s4">&quot;dd&quot;</span><span class="s3">: </span><span class="s6">[</span><span class="s4">&quot;dt&quot;</span><span class="s2">, </span><span class="s4">&quot;dd&quot;</span><span class="s6">]}</span>
            <span class="s1">stopNames </span><span class="s3">= </span><span class="s1">stopNamesMap</span><span class="s6">[</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]]</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">stopNames</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span>
                        <span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s4">&quot;EndTag&quot;</span><span class="s2">))</span>
                    <span class="s0">break</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">nameTuple </span><span class="s0">in </span><span class="s1">specialElements </span><span class="s0">and</span>
                        <span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s2">(</span><span class="s4">&quot;address&quot;</span><span class="s2">, </span><span class="s4">&quot;div&quot;</span><span class="s2">, </span><span class="s4">&quot;p&quot;</span><span class="s2">))</span><span class="s3">:</span>
                    <span class="s0">break</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span>
                    <span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s4">&quot;EndTag&quot;</span><span class="s2">))</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagPlaintext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">plaintextState</span>

        <span class="s0">def </span><span class="s1">startTagHeading</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">headingElements</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagA</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">afeAElement </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInActiveFormattingElements</span><span class="s2">(</span><span class="s4">&quot;a&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">afeAElement</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;startName&quot;</span><span class="s3">: </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;endName&quot;</span><span class="s3">: </span><span class="s4">&quot;a&quot;</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagFormatting</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;a&quot;</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">afeAElement </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">afeAElement</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">afeAElement </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">afeAElement</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addFormattingElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagFormatting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addFormattingElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagNobr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;nobr&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;startName&quot;</span><span class="s3">: </span><span class="s4">&quot;nobr&quot;</span><span class="s2">, </span><span class="s4">&quot;endName&quot;</span><span class="s3">: </span><span class="s4">&quot;nobr&quot;</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;nobr&quot;</span><span class="s2">))</span>
                <span class="s5"># XXX Need tests that trigger the following</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">addFormattingElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagButton</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;startName&quot;</span><span class="s3">: </span><span class="s4">&quot;button&quot;</span><span class="s2">, </span><span class="s4">&quot;endName&quot;</span><span class="s3">: </span><span class="s4">&quot;button&quot;</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;button&quot;</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagAppletMarqueeObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Marker</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagXmp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseRCDataRawtext</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s4">&quot;RAWTEXT&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">compatMode </span><span class="s3">!= </span><span class="s4">&quot;quirks&quot;</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagVoidFormatting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagInput</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">framesetOK </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagVoidFormatting</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s4">&quot;type&quot; </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s0">and</span>
                    <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">][</span><span class="s4">&quot;type&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">asciiUpper2Lower</span><span class="s2">) </span><span class="s3">== </span><span class="s4">&quot;hidden&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s5"># input type=hidden doesn't change framesetOK</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s1">framesetOK</span>

        <span class="s0">def </span><span class="s1">startTagParamSource</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagHr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagImage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># No really...</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-treated-as&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;originalName&quot;</span><span class="s3">: </span><span class="s4">&quot;image&quot;</span><span class="s2">, </span><span class="s4">&quot;newName&quot;</span><span class="s3">: </span><span class="s4">&quot;img&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;img&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">,</span>
                                                 <span class="s1">attributes</span><span class="s3">=</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">,</span>
                                                 <span class="s1">selfClosing</span><span class="s3">=</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosing&quot;</span><span class="s6">]</span><span class="s2">))</span>

        <span class="s0">def </span><span class="s1">startTagIsIndex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;deprecated-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;isindex&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">formPointer</span><span class="s3">:</span>
                <span class="s0">return</span>
            <span class="s1">form_attrs </span><span class="s3">= </span><span class="s6">{}</span>
            <span class="s0">if </span><span class="s4">&quot;action&quot; </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">form_attrs</span><span class="s6">[</span><span class="s4">&quot;action&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">][</span><span class="s4">&quot;action&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;form&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">,</span>
                                                 <span class="s1">attributes</span><span class="s3">=</span><span class="s1">form_attrs</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;hr&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;label&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s5"># XXX Localization ...</span>
            <span class="s0">if </span><span class="s4">&quot;prompt&quot; </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">prompt </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">][</span><span class="s4">&quot;prompt&quot;</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">prompt </span><span class="s3">= </span><span class="s4">&quot;This is a searchable index. Enter search keywords: &quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span>
                <span class="s6">{</span><span class="s4">&quot;type&quot;</span><span class="s3">: </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;Characters&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s3">: </span><span class="s1">prompt</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s1">attributes </span><span class="s3">= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s4">&quot;action&quot; </span><span class="s0">in </span><span class="s1">attributes</span><span class="s3">:</span>
                <span class="s0">del </span><span class="s1">attributes</span><span class="s6">[</span><span class="s4">&quot;action&quot;</span><span class="s6">]</span>
            <span class="s0">if </span><span class="s4">&quot;prompt&quot; </span><span class="s0">in </span><span class="s1">attributes</span><span class="s3">:</span>
                <span class="s0">del </span><span class="s1">attributes</span><span class="s6">[</span><span class="s4">&quot;prompt&quot;</span><span class="s6">]</span>
            <span class="s1">attributes</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s4">&quot;isindex&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;input&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">,</span>
                                                 <span class="s1">attributes</span><span class="s3">=</span><span class="s1">attributes</span><span class="s2">,</span>
                                                 <span class="s1">selfClosing</span><span class="s3">=</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosing&quot;</span><span class="s6">]</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;label&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;hr&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;form&quot;</span><span class="s2">))</span>

        <span class="s0">def </span><span class="s1">startTagTextarea</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">state </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tokenizer</span><span class="s2">.</span><span class="s1">rcdataState</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharacters </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharactersDropNewline</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagIFrame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagRawtext</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagNoscript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">scripting</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagRawtext</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagRawtext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5">&quot;&quot;&quot;iframe, noembed noframes, noscript(if scripting enabled)&quot;&quot;&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseRCDataRawtext</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s4">&quot;RAWTEXT&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOpt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;option&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;option&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagSelect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s0">in </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">,</span>
                                     <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inCaption&quot;</span><span class="s6">]</span><span class="s2">,</span>
                                     <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inColumnGroup&quot;</span><span class="s6">]</span><span class="s2">,</span>
                                     <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTableBody&quot;</span><span class="s6">]</span><span class="s2">,</span>
                                     <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inRow&quot;</span><span class="s6">]</span><span class="s2">,</span>
                                     <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inCell&quot;</span><span class="s6">]</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inSelectInTable&quot;</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inSelect&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagRpRt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;ruby&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;ruby&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagMath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">adjustMathMLAttributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">adjustForeignAttributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;namespace&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s1">namespaces</span><span class="s6">[</span><span class="s4">&quot;mathml&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s5"># Need to get the parse error right for the case where the token</span>
            <span class="s5"># has a namespace not equal to the xmlns attribute</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosing&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagSvg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">adjustSVGAttributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">adjustForeignAttributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;namespace&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s1">namespaces</span><span class="s6">[</span><span class="s4">&quot;svg&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s5"># Need to get the parse error right for the case where the token</span>
            <span class="s5"># has a namespace not equal to the xmlns attribute</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosing&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagMisplaced</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5">&quot;&quot;&quot; Elements that should be children of other elements that have a 
            different insertion mode; here they are ignored 
            &quot;caption&quot;, &quot;col&quot;, &quot;colgroup&quot;, &quot;frame&quot;, &quot;frameset&quot;, &quot;head&quot;, 
            &quot;option&quot;, &quot;optgroup&quot;, &quot;tbody&quot;, &quot;td&quot;, &quot;tfoot&quot;, &quot;th&quot;, &quot;thead&quot;, 
            &quot;tr&quot;, &quot;noscript&quot; 
            &quot;&quot;&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-ignored&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;button&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagCloseP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;p&quot;</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagP</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s4">&quot;EndTag&quot;</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;p&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;p&quot;</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s0">while </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;p&quot;</span><span class="s3">:</span>
                    <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagBody</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>
                <span class="s0">return</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;body&quot;</span><span class="s3">:</span>
                <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">2</span><span class="s3">:</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">frozenset</span><span class="s2">((</span><span class="s4">&quot;dd&quot;</span><span class="s2">, </span><span class="s4">&quot;dt&quot;</span><span class="s2">, </span><span class="s4">&quot;li&quot;</span><span class="s2">, </span><span class="s4">&quot;optgroup&quot;</span><span class="s2">,</span>
                                                   <span class="s4">&quot;option&quot;</span><span class="s2">, </span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s4">&quot;rp&quot;</span><span class="s2">, </span><span class="s4">&quot;rt&quot;</span><span class="s2">,</span>
                                                   <span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">,</span>
                                                   <span class="s4">&quot;th&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s4">&quot;body&quot;</span><span class="s2">,</span>
                                                   <span class="s4">&quot;html&quot;</span><span class="s2">))</span><span class="s3">:</span>
                        <span class="s5"># Not sure this is the correct name for the parse error</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span>
                            <span class="s4">&quot;expected-one-end-tag-but-got-another&quot;</span><span class="s2">,</span>
                            <span class="s6">{</span><span class="s4">&quot;gotName&quot;</span><span class="s3">: </span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;expectedName&quot;</span><span class="s3">: </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span><span class="s6">}</span><span class="s2">)</span>
                        <span class="s0">break</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;afterBody&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># We repeat the test for the body end tag token being ignored here</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagBody</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagBlock</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Put us back in the right whitespace handling mode</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;pre&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharacters </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">processSpaceCharactersNonPre</span>
            <span class="s1">inScope </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">inScope</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;end-tag-too-early&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">inScope</span><span class="s3">:</span>
                <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s0">while </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagForm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">formPointer</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">formPointer </span><span class="s3">= </span><span class="s0">None</span>
            <span class="s0">if </span><span class="s1">node </span><span class="s0">is None or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;form&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">] </span><span class="s3">!= </span><span class="s1">node</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;end-tag-too-early-ignored&quot;</span><span class="s2">,</span>
                                           <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;form&quot;</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagListItem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;li&quot;</span><span class="s3">:</span>
                <span class="s1">variant </span><span class="s3">= </span><span class="s4">&quot;list&quot;</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">variant </span><span class="s3">= </span><span class="s0">None</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s1">variant</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">(</span><span class="s1">exclude</span><span class="s3">=</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span>
                        <span class="s4">&quot;end-tag-too-early&quot;</span><span class="s2">,</span>
                        <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s0">while </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagHeading</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">headingElements</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">()</span>
                    <span class="s0">break</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;end-tag-too-early&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

            <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">headingElements</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s1">item </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                    <span class="s0">while </span><span class="s1">item</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">headingElements</span><span class="s3">:</span>
                        <span class="s1">item </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                    <span class="s0">break</span>

        <span class="s0">def </span><span class="s1">endTagFormatting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5">&quot;&quot;&quot;The much-feared adoption agency algorithm&quot;&quot;&quot;</span>
            <span class="s5"># http://svn.whatwg.org/webapps/complete.html#adoptionAgency revision 7867</span>
            <span class="s5"># XXX Better parseError messages appreciated.</span>

            <span class="s5"># Step 1</span>
            <span class="s1">outerLoopCounter </span><span class="s3">= </span><span class="s7">0</span>

            <span class="s5"># Step 2</span>
            <span class="s0">while </span><span class="s1">outerLoopCounter </span><span class="s3">&lt; </span><span class="s7">8</span><span class="s3">:</span>

                <span class="s5"># Step 3</span>
                <span class="s1">outerLoopCounter </span><span class="s3">+= </span><span class="s7">1</span>

                <span class="s5"># Step 4:</span>

                <span class="s5"># Let the formatting element be the last element in</span>
                <span class="s5"># the list of active formatting elements that:</span>
                <span class="s5"># - is between the end of the list and the last scope</span>
                <span class="s5"># marker in the list, if any, or the start of the list</span>
                <span class="s5"># otherwise, and</span>
                <span class="s5"># - has the same tag name as the token.</span>
                <span class="s1">formattingElement </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInActiveFormattingElements</span><span class="s2">(</span>
                    <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s0">not </span><span class="s1">formattingElement </span><span class="s0">or</span>
                    <span class="s2">(</span><span class="s1">formattingElement </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements </span><span class="s0">and</span>
                     <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">formattingElement</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)))</span><span class="s3">:</span>
                    <span class="s5"># If there is no such node, then abort these steps</span>
                    <span class="s5"># and instead act as described in the &quot;any other</span>
                    <span class="s5"># end tag&quot; entry below.</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                    <span class="s0">return</span>

                <span class="s5"># Otherwise, if there is such a node, but that node is</span>
                <span class="s5"># not in the stack of open elements, then this is a</span>
                <span class="s5"># parse error; remove the element from the list, and</span>
                <span class="s5"># abort these steps.</span>
                <span class="s0">elif </span><span class="s1">formattingElement </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;adoption-agency-1.2&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">formattingElement</span><span class="s2">)</span>
                    <span class="s0">return</span>

                <span class="s5"># Otherwise, if there is such a node, and that node is</span>
                <span class="s5"># also in the stack of open elements, but the element</span>
                <span class="s5"># is not in scope, then this is a parse error; ignore</span>
                <span class="s5"># the token, and abort these steps.</span>
                <span class="s0">elif not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">formattingElement</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;adoption-agency-4.4&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                    <span class="s0">return</span>

                <span class="s5"># Otherwise, there is a formatting element and that</span>
                <span class="s5"># element is in the stack and is in scope. If the</span>
                <span class="s5"># element is not the current node, this is a parse</span>
                <span class="s5"># error. In any case, proceed with the algorithm as</span>
                <span class="s5"># written in the following steps.</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s0">if </span><span class="s1">formattingElement </span><span class="s3">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;adoption-agency-1.3&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

                <span class="s5"># Step 5:</span>

                <span class="s5"># Let the furthest block be the topmost node in the</span>
                <span class="s5"># stack of open elements that is lower in the stack</span>
                <span class="s5"># than the formatting element, and is an element in</span>
                <span class="s5"># the special category. There might not be one.</span>
                <span class="s1">afeIndex </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">formattingElement</span><span class="s2">)</span>
                <span class="s1">furthestBlock </span><span class="s3">= </span><span class="s0">None</span>
                <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s1">afeIndex</span><span class="s3">:</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s0">if </span><span class="s1">element</span><span class="s2">.</span><span class="s1">nameTuple </span><span class="s0">in </span><span class="s1">specialElements</span><span class="s3">:</span>
                        <span class="s1">furthestBlock </span><span class="s3">= </span><span class="s1">element</span>
                        <span class="s0">break</span>

                <span class="s5"># Step 6:</span>

                <span class="s5"># If there is no furthest block, then the UA must</span>
                <span class="s5"># first pop all the nodes from the bottom of the stack</span>
                <span class="s5"># of open elements, from the current node up to and</span>
                <span class="s5"># including the formatting element, then remove the</span>
                <span class="s5"># formatting element from the list of active</span>
                <span class="s5"># formatting elements, and finally abort these steps.</span>
                <span class="s0">if </span><span class="s1">furthestBlock </span><span class="s0">is None</span><span class="s3">:</span>
                    <span class="s1">element </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                    <span class="s0">while </span><span class="s1">element </span><span class="s3">!= </span><span class="s1">formattingElement</span><span class="s3">:</span>
                        <span class="s1">element </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">element</span><span class="s2">)</span>
                    <span class="s0">return</span>

                <span class="s5"># Step 7</span>
                <span class="s1">commonAncestor </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s1">afeIndex </span><span class="s3">- </span><span class="s7">1</span><span class="s6">]</span>

                <span class="s5"># Step 8:</span>
                <span class="s5"># The bookmark is supposed to help us identify where to reinsert</span>
                <span class="s5"># nodes in step 15. We have to ensure that we reinsert nodes after</span>
                <span class="s5"># the node before the active formatting element. Note the bookmark</span>
                <span class="s5"># can move in step 9.7</span>
                <span class="s1">bookmark </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">formattingElement</span><span class="s2">)</span>

                <span class="s5"># Step 9</span>
                <span class="s1">lastNode </span><span class="s3">= </span><span class="s1">node </span><span class="s3">= </span><span class="s1">furthestBlock</span>
                <span class="s1">innerLoopCounter </span><span class="s3">= </span><span class="s7">0</span>

                <span class="s1">index </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
                <span class="s0">while </span><span class="s1">innerLoopCounter </span><span class="s3">&lt; </span><span class="s7">3</span><span class="s3">:</span>
                    <span class="s1">innerLoopCounter </span><span class="s3">+= </span><span class="s7">1</span>
                    <span class="s5"># Node is element before node in open elements</span>
                    <span class="s1">index </span><span class="s3">-= </span><span class="s7">1</span>
                    <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s1">index</span><span class="s6">]</span>
                    <span class="s0">if </span><span class="s1">node </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
                        <span class="s0">continue</span>
                    <span class="s5"># Step 9.6</span>
                    <span class="s0">if </span><span class="s1">node </span><span class="s3">== </span><span class="s1">formattingElement</span><span class="s3">:</span>
                        <span class="s0">break</span>
                    <span class="s5"># Step 9.7</span>
                    <span class="s0">if </span><span class="s1">lastNode </span><span class="s3">== </span><span class="s1">furthestBlock</span><span class="s3">:</span>
                        <span class="s1">bookmark </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">node</span><span class="s2">) </span><span class="s3">+ </span><span class="s7">1</span>
                    <span class="s5"># Step 9.8</span>
                    <span class="s1">clone </span><span class="s3">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">cloneNode</span><span class="s2">()</span>
                    <span class="s5"># Replace node with clone</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s6">[</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span><span class="s6">] </span><span class="s3">= </span><span class="s1">clone</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span><span class="s6">] </span><span class="s3">= </span><span class="s1">clone</span>
                    <span class="s1">node </span><span class="s3">= </span><span class="s1">clone</span>
                    <span class="s5"># Step 9.9</span>
                    <span class="s5"># Remove lastNode from its parents, if any</span>
                    <span class="s0">if </span><span class="s1">lastNode</span><span class="s2">.</span><span class="s1">parent</span><span class="s3">:</span>
                        <span class="s1">lastNode</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">removeChild</span><span class="s2">(</span><span class="s1">lastNode</span><span class="s2">)</span>
                    <span class="s1">node</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">lastNode</span><span class="s2">)</span>
                    <span class="s5"># Step 9.10</span>
                    <span class="s1">lastNode </span><span class="s3">= </span><span class="s1">node</span>

                <span class="s5"># Step 10</span>
                <span class="s5"># Foster parent lastNode if commonAncestor is a</span>
                <span class="s5"># table, tbody, tfoot, thead, or tr we need to foster</span>
                <span class="s5"># parent the lastNode</span>
                <span class="s0">if </span><span class="s1">lastNode</span><span class="s2">.</span><span class="s1">parent</span><span class="s3">:</span>
                    <span class="s1">lastNode</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">removeChild</span><span class="s2">(</span><span class="s1">lastNode</span><span class="s2">)</span>

                <span class="s0">if </span><span class="s1">commonAncestor</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">frozenset</span><span class="s2">((</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">))</span><span class="s3">:</span>
                    <span class="s1">parent</span><span class="s2">, </span><span class="s1">insertBefore </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">getTableMisnestedNodePosition</span><span class="s2">()</span>
                    <span class="s1">parent</span><span class="s2">.</span><span class="s1">insertBefore</span><span class="s2">(</span><span class="s1">lastNode</span><span class="s2">, </span><span class="s1">insertBefore</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s1">commonAncestor</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">lastNode</span><span class="s2">)</span>

                <span class="s5"># Step 11</span>
                <span class="s1">clone </span><span class="s3">= </span><span class="s1">formattingElement</span><span class="s2">.</span><span class="s1">cloneNode</span><span class="s2">()</span>

                <span class="s5"># Step 12</span>
                <span class="s1">furthestBlock</span><span class="s2">.</span><span class="s1">reparentChildren</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">)</span>

                <span class="s5"># Step 13</span>
                <span class="s1">furthestBlock</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">)</span>

                <span class="s5"># Step 14</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">formattingElement</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">bookmark</span><span class="s2">, </span><span class="s1">clone</span><span class="s2">)</span>

                <span class="s5"># Step 15</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">formattingElement</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">furthestBlock</span><span class="s2">) </span><span class="s3">+ </span><span class="s7">1</span><span class="s2">, </span><span class="s1">clone</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagAppletMarqueeObject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;end-tag-too-early&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">element </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s0">while </span><span class="s1">element</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">element </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">clearActiveFormattingElements</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagBr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-treated-as&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;originalName&quot;</span><span class="s3">: </span><span class="s4">&quot;br&quot;</span><span class="s2">, </span><span class="s4">&quot;newName&quot;</span><span class="s3">: </span><span class="s4">&quot;br element&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">reconstructActiveFormattingElements</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;br&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">::-</span><span class="s7">1</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">(</span><span class="s1">exclude</span><span class="s3">=</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                    <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() </span><span class="s3">!= </span><span class="s1">node</span><span class="s3">:</span>
                        <span class="s0">pass</span>
                    <span class="s0">break</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">nameTuple </span><span class="s0">in </span><span class="s1">specialElements</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                        <span class="s0">break</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;base&quot;</span><span class="s2">, </span><span class="s4">&quot;basefont&quot;</span><span class="s2">, </span><span class="s4">&quot;bgsound&quot;</span><span class="s2">, </span><span class="s4">&quot;command&quot;</span><span class="s2">, </span><span class="s4">&quot;link&quot;</span><span class="s2">, </span><span class="s4">&quot;meta&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;script&quot;</span><span class="s2">, </span><span class="s4">&quot;style&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">),</span>
             <span class="s1">startTagProcessInHead</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s1">startTagBody</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;frameset&quot;</span><span class="s2">, </span><span class="s1">startTagFrameset</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;address&quot;</span><span class="s2">, </span><span class="s4">&quot;article&quot;</span><span class="s2">, </span><span class="s4">&quot;aside&quot;</span><span class="s2">, </span><span class="s4">&quot;blockquote&quot;</span><span class="s2">, </span><span class="s4">&quot;center&quot;</span><span class="s2">, </span><span class="s4">&quot;details&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;dir&quot;</span><span class="s2">, </span><span class="s4">&quot;div&quot;</span><span class="s2">, </span><span class="s4">&quot;dl&quot;</span><span class="s2">, </span><span class="s4">&quot;fieldset&quot;</span><span class="s2">, </span><span class="s4">&quot;figcaption&quot;</span><span class="s2">, </span><span class="s4">&quot;figure&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;footer&quot;</span><span class="s2">, </span><span class="s4">&quot;header&quot;</span><span class="s2">, </span><span class="s4">&quot;hgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;main&quot;</span><span class="s2">, </span><span class="s4">&quot;menu&quot;</span><span class="s2">, </span><span class="s4">&quot;nav&quot;</span><span class="s2">, </span><span class="s4">&quot;ol&quot;</span><span class="s2">, </span><span class="s4">&quot;p&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;section&quot;</span><span class="s2">, </span><span class="s4">&quot;summary&quot;</span><span class="s2">, </span><span class="s4">&quot;ul&quot;</span><span class="s2">),</span>
             <span class="s1">startTagCloseP</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">headingElements</span><span class="s2">, </span><span class="s1">startTagHeading</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;pre&quot;</span><span class="s2">, </span><span class="s4">&quot;listing&quot;</span><span class="s2">), </span><span class="s1">startTagPreListing</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;form&quot;</span><span class="s2">, </span><span class="s1">startTagForm</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;li&quot;</span><span class="s2">, </span><span class="s4">&quot;dd&quot;</span><span class="s2">, </span><span class="s4">&quot;dt&quot;</span><span class="s2">), </span><span class="s1">startTagListItem</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;plaintext&quot;</span><span class="s2">, </span><span class="s1">startTagPlaintext</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s1">startTagA</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;big&quot;</span><span class="s2">, </span><span class="s4">&quot;code&quot;</span><span class="s2">, </span><span class="s4">&quot;em&quot;</span><span class="s2">, </span><span class="s4">&quot;font&quot;</span><span class="s2">, </span><span class="s4">&quot;i&quot;</span><span class="s2">, </span><span class="s4">&quot;s&quot;</span><span class="s2">, </span><span class="s4">&quot;small&quot;</span><span class="s2">, </span><span class="s4">&quot;strike&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;strong&quot;</span><span class="s2">, </span><span class="s4">&quot;tt&quot;</span><span class="s2">, </span><span class="s4">&quot;u&quot;</span><span class="s2">), </span><span class="s1">startTagFormatting</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;nobr&quot;</span><span class="s2">, </span><span class="s1">startTagNobr</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;button&quot;</span><span class="s2">, </span><span class="s1">startTagButton</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;applet&quot;</span><span class="s2">, </span><span class="s4">&quot;marquee&quot;</span><span class="s2">, </span><span class="s4">&quot;object&quot;</span><span class="s2">), </span><span class="s1">startTagAppletMarqueeObject</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;xmp&quot;</span><span class="s2">, </span><span class="s1">startTagXmp</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s1">startTagTable</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;area&quot;</span><span class="s2">, </span><span class="s4">&quot;br&quot;</span><span class="s2">, </span><span class="s4">&quot;embed&quot;</span><span class="s2">, </span><span class="s4">&quot;img&quot;</span><span class="s2">, </span><span class="s4">&quot;keygen&quot;</span><span class="s2">, </span><span class="s4">&quot;wbr&quot;</span><span class="s2">),</span>
             <span class="s1">startTagVoidFormatting</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;param&quot;</span><span class="s2">, </span><span class="s4">&quot;source&quot;</span><span class="s2">, </span><span class="s4">&quot;track&quot;</span><span class="s2">), </span><span class="s1">startTagParamSource</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;input&quot;</span><span class="s2">, </span><span class="s1">startTagInput</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;hr&quot;</span><span class="s2">, </span><span class="s1">startTagHr</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;image&quot;</span><span class="s2">, </span><span class="s1">startTagImage</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;isindex&quot;</span><span class="s2">, </span><span class="s1">startTagIsIndex</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;textarea&quot;</span><span class="s2">, </span><span class="s1">startTagTextarea</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;iframe&quot;</span><span class="s2">, </span><span class="s1">startTagIFrame</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;noscript&quot;</span><span class="s2">, </span><span class="s1">startTagNoscript</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;noembed&quot;</span><span class="s2">, </span><span class="s4">&quot;noframes&quot;</span><span class="s2">), </span><span class="s1">startTagRawtext</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">, </span><span class="s1">startTagSelect</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;rp&quot;</span><span class="s2">, </span><span class="s4">&quot;rt&quot;</span><span class="s2">), </span><span class="s1">startTagRpRt</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;option&quot;</span><span class="s2">, </span><span class="s4">&quot;optgroup&quot;</span><span class="s2">), </span><span class="s1">startTagOpt</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;math&quot;</span><span class="s2">), </span><span class="s1">startTagMath</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;svg&quot;</span><span class="s2">), </span><span class="s1">startTagSvg</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;frame&quot;</span><span class="s2">, </span><span class="s4">&quot;head&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">startTagMisplaced</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s1">endTagBody</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">endTagHtml</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;address&quot;</span><span class="s2">, </span><span class="s4">&quot;article&quot;</span><span class="s2">, </span><span class="s4">&quot;aside&quot;</span><span class="s2">, </span><span class="s4">&quot;blockquote&quot;</span><span class="s2">, </span><span class="s4">&quot;button&quot;</span><span class="s2">, </span><span class="s4">&quot;center&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;details&quot;</span><span class="s2">, </span><span class="s4">&quot;dialog&quot;</span><span class="s2">, </span><span class="s4">&quot;dir&quot;</span><span class="s2">, </span><span class="s4">&quot;div&quot;</span><span class="s2">, </span><span class="s4">&quot;dl&quot;</span><span class="s2">, </span><span class="s4">&quot;fieldset&quot;</span><span class="s2">, </span><span class="s4">&quot;figcaption&quot;</span><span class="s2">, </span><span class="s4">&quot;figure&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;footer&quot;</span><span class="s2">, </span><span class="s4">&quot;header&quot;</span><span class="s2">, </span><span class="s4">&quot;hgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;listing&quot;</span><span class="s2">, </span><span class="s4">&quot;main&quot;</span><span class="s2">, </span><span class="s4">&quot;menu&quot;</span><span class="s2">, </span><span class="s4">&quot;nav&quot;</span><span class="s2">, </span><span class="s4">&quot;ol&quot;</span><span class="s2">, </span><span class="s4">&quot;pre&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;section&quot;</span><span class="s2">, </span><span class="s4">&quot;summary&quot;</span><span class="s2">, </span><span class="s4">&quot;ul&quot;</span><span class="s2">), </span><span class="s1">endTagBlock</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;form&quot;</span><span class="s2">, </span><span class="s1">endTagForm</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s1">endTagP</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;dd&quot;</span><span class="s2">, </span><span class="s4">&quot;dt&quot;</span><span class="s2">, </span><span class="s4">&quot;li&quot;</span><span class="s2">), </span><span class="s1">endTagListItem</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">headingElements</span><span class="s2">, </span><span class="s1">endTagHeading</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;big&quot;</span><span class="s2">, </span><span class="s4">&quot;code&quot;</span><span class="s2">, </span><span class="s4">&quot;em&quot;</span><span class="s2">, </span><span class="s4">&quot;font&quot;</span><span class="s2">, </span><span class="s4">&quot;i&quot;</span><span class="s2">, </span><span class="s4">&quot;nobr&quot;</span><span class="s2">, </span><span class="s4">&quot;s&quot;</span><span class="s2">, </span><span class="s4">&quot;small&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;strike&quot;</span><span class="s2">, </span><span class="s4">&quot;strong&quot;</span><span class="s2">, </span><span class="s4">&quot;tt&quot;</span><span class="s2">, </span><span class="s4">&quot;u&quot;</span><span class="s2">), </span><span class="s1">endTagFormatting</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;applet&quot;</span><span class="s2">, </span><span class="s4">&quot;marquee&quot;</span><span class="s2">, </span><span class="s4">&quot;object&quot;</span><span class="s2">), </span><span class="s1">endTagAppletMarqueeObject</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;br&quot;</span><span class="s2">, </span><span class="s1">endTagBr</span><span class="s2">),</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">TextPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-named-closing-tag-but-got-eof&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">originalPhase</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">assert False</span><span class="s2">, </span><span class="s4">&quot;Tried to process start tag %s in RCDATA/RAWTEXT mode&quot; </span><span class="s3">% </span><span class="s1">token</span><span class="s6">[</span><span class="s4">'name'</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagScript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;script&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">originalPhase</span>
            <span class="s5"># The rest of this method is all stuff that only happens if</span>
            <span class="s5"># document.write works</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">originalPhase</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>
        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;script&quot;</span><span class="s2">, </span><span class="s1">endTagScript</span><span class="s2">)</span><span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InTablePhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-table</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s5"># helper methods</span>
        <span class="s0">def </span><span class="s1">clearStackToTableContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># &quot;clear the stack back to a table context&quot;</span>
            <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s5"># self.parser.parseError(&quot;unexpected-implied-end-tag-in-table&quot;,</span>
                <span class="s5">#  {&quot;name&quot;:  self.tree.openElements[-1].name})</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s5"># When the current node is &lt;html&gt; it's an innerHTML case</span>

        <span class="s5"># processing methods</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;eof-in-table&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
            <span class="s5"># Stop parsing</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">originalPhase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTableText&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">originalPhase </span><span class="s3">= </span><span class="s1">originalPhase</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">originalPhase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTableText&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">originalPhase </span><span class="s3">= </span><span class="s1">originalPhase</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># If we get here there must be at least one non-whitespace character</span>
            <span class="s5"># Do the table magic!</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertFromTable </span><span class="s3">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertFromTable </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">startTagCaption</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableContext</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Marker</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inCaption&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagColgroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableContext</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inColumnGroup&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagCol</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagColgroup</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagRowGroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableContext</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTableBody&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagImplyTbody</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagRowGroup</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-implies-end-tag&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;startName&quot;</span><span class="s3">: </span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s4">&quot;endName&quot;</span><span class="s3">: </span><span class="s4">&quot;table&quot;</span><span class="s6">}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">))</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagStyleScript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagInput</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s4">&quot;type&quot; </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s0">and</span>
                    <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">][</span><span class="s4">&quot;type&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">asciiUpper2Lower</span><span class="s2">) </span><span class="s3">== </span><span class="s4">&quot;hidden&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-hidden-input-in-table&quot;</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s5"># XXX associate with form</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagForm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-form-in-table&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">formPointer </span><span class="s0">is None</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">formPointer </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-implies-table-voodoo&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s5"># Do the table magic!</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertFromTable </span><span class="s3">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertFromTable </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">endTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;table&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;end-tag-too-early-named&quot;</span><span class="s2">,</span>
                                           <span class="s6">{</span><span class="s4">&quot;gotName&quot;</span><span class="s3">: </span><span class="s4">&quot;table&quot;</span><span class="s2">,</span>
                                            <span class="s4">&quot;expectedName&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;table&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">resetInsertionMode</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagIgnore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-implies-table-voodoo&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s5"># Do the table magic!</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertFromTable </span><span class="s3">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertFromTable </span><span class="s3">= </span><span class="s0">False</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s1">startTagCaption</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s1">startTagColgroup</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s1">startTagCol</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">), </span><span class="s1">startTagRowGroup</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">startTagImplyTbody</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s1">startTagTable</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;style&quot;</span><span class="s2">, </span><span class="s4">&quot;script&quot;</span><span class="s2">), </span><span class="s1">startTagStyleScript</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;input&quot;</span><span class="s2">, </span><span class="s1">startTagInput</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;form&quot;</span><span class="s2">, </span><span class="s1">startTagForm</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s1">endTagTable</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">endTagIgnore</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InTableTextPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s2">(</span><span class="s4">&quot;originalPhase&quot;</span><span class="s2">, </span><span class="s4">&quot;characterTokens&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">InTableTextPhase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s3">*</span><span class="s1">args</span><span class="s2">, </span><span class="s3">**</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">originalPhase </span><span class="s3">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">characterTokens </span><span class="s3">= </span><span class="s6">[]</span>

        <span class="s0">def </span><span class="s1">flushCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s6">[</span><span class="s1">item</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">characterTokens</span><span class="s6">]</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s6">[</span><span class="s1">item </span><span class="s0">not in </span><span class="s1">spaceCharacters </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s6">]</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">token </span><span class="s3">= </span><span class="s6">{</span><span class="s4">&quot;type&quot;</span><span class="s3">: </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s4">&quot;Characters&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s3">: </span><span class="s1">data</span><span class="s6">}</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">data</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">characterTokens </span><span class="s3">= </span><span class="s6">[]</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flushCharacters</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">originalPhase</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flushCharacters</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">originalPhase</span>
            <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;\u0000&quot;</span><span class="s3">:</span>
                <span class="s0">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">characterTokens</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># pretty sure we should never reach here</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">characterTokens</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
    <span class="s5">#        assert False</span>

        <span class="s0">def </span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flushCharacters</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">originalPhase</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flushCharacters</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">originalPhase</span>
            <span class="s0">return </span><span class="s1">token</span>

    <span class="s0">class </span><span class="s1">InCaptionPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-caption</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">ignoreEndTagCaption</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEOF</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTableElement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>
            <span class="s5"># XXX Have to duplicate logic here to find out if the tag is ignored</span>
            <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagCaption</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;caption&quot;</span><span class="s2">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagCaption</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagCaption</span><span class="s2">()</span><span class="s3">:</span>
                <span class="s5"># AT this code is quite similar to endTagTable in &quot;InTable&quot;</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;caption&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-one-end-tag-but-got-another&quot;</span><span class="s2">,</span>
                                           <span class="s6">{</span><span class="s4">&quot;gotName&quot;</span><span class="s3">: </span><span class="s4">&quot;caption&quot;</span><span class="s2">,</span>
                                            <span class="s4">&quot;expectedName&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;caption&quot;</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">clearActiveFormattingElements</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>
            <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagCaption</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;caption&quot;</span><span class="s2">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagIgnore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">startTagTableElement</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s1">endTagCaption</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s1">endTagTable</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">endTagIgnore</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InColumnGroupPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-column</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">ignoreEndTagColgroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;html&quot;</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s0">return</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagColgroup</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagColgroup</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;colgroup&quot;</span><span class="s2">))</span>
                <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                    <span class="s0">return True</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagColgroup</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagColgroup</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;colgroup&quot;</span><span class="s2">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagCol</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagColgroup</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagColgroup</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;colgroup&quot;</span><span class="s2">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagColgroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagColgroup</span><span class="s2">()</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagCol</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;no-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;col&quot;</span><span class="s6">}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagColgroup</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagColgroup</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;colgroup&quot;</span><span class="s2">))</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s1">startTagCol</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s1">endTagColgroup</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s1">endTagCol</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InTableBodyPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-table0</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s5"># helper methods</span>
        <span class="s0">def </span><span class="s1">clearStackToTableBodyContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s2">(</span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">,</span>
                                                          <span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s5"># self.parser.parseError(&quot;unexpected-implied-end-tag-in-table&quot;,</span>
                <span class="s5">#  {&quot;name&quot;: self.tree.openElements[-1].name})</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>

        <span class="s5"># the rest</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEOF</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableBodyContext</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inRow&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">startTagTableCell</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-cell-in-table-body&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">startTagTr</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s4">&quot;StartTag&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagTableOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># XXX AT Any ideas on how to share this with endTagTable?</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">) </span><span class="s0">or</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">))</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableBodyContext</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagTableRowGroup</span><span class="s2">(</span>
                    <span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagTableRowGroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableBodyContext</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-in-table-body&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">) </span><span class="s0">or</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">))</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableBodyContext</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagTableRowGroup</span><span class="s2">(</span>
                    <span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagIgnore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-in-table-body&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s1">startTagTr</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">), </span><span class="s1">startTagTableCell</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">),</span>
             <span class="s1">startTagTableOther</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">((</span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">), </span><span class="s1">endTagTableRowGroup</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s1">endTagTable</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">endTagIgnore</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InRowPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-row</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s5"># helper methods (XXX unify this with other table helper methods)</span>
        <span class="s0">def </span><span class="s1">clearStackToTableRowContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-implied-end-tag-in-table-row&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name</span><span class="s6">}</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">ignoreEndTagTr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span>

        <span class="s5"># the rest</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEOF</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTableCell</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableRowContext</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inCell&quot;</span><span class="s6">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">activeFormattingElements</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Marker</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTableOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagTr</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagTr</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">))</span>
            <span class="s5"># XXX how are we sure it's always ignored in the innerHTML case?</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagTr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagTr</span><span class="s2">()</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">clearStackToTableRowContext</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTableBody&quot;</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">ignoreEndTag </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignoreEndTagTr</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagTr</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">))</span>
            <span class="s5"># Reprocess the current tag if the tr end tag was not ignored</span>
            <span class="s5"># XXX how are we sure it's always ignored in the innerHTML case?</span>
            <span class="s0">if not </span><span class="s1">ignoreEndTag</span><span class="s3">:</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagTableRowGroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagTr</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagIgnore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-in-table-row&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTable&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">), </span><span class="s1">startTagTableCell</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">startTagTableOther</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s1">endTagTr</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s1">endTagTable</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">), </span><span class="s1">endTagTableRowGroup</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">),</span>
             <span class="s1">endTagIgnore</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InCellPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-cell</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s5"># helper</span>
        <span class="s0">def </span><span class="s1">closeCell</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagTableCell</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;td&quot;</span><span class="s2">))</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;th&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagTableCell</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;th&quot;</span><span class="s2">))</span>

        <span class="s5"># the rest</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEOF</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTableOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;th&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">))</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">closeCell</span><span class="s2">()</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagTableCell</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">generateImpliedEndTags</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-cell-end-tag&quot;</span><span class="s2">,</span>
                                           <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                    <span class="s0">while True</span><span class="s3">:</span>
                        <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                        <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                            <span class="s0">break</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">clearActiveFormattingElements</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inRow&quot;</span><span class="s6">]</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagIgnore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagImply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">closeCell</span><span class="s2">()</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># sometimes innerHTML case</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">,</span>
              <span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">startTagTableOther</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">((</span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">), </span><span class="s1">endTagTableCell</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;colgroup&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">), </span><span class="s1">endTagIgnore</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">), </span><span class="s1">endTagImply</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InSelectPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-select</span>
        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;eof-in-select&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;\u0000&quot;</span><span class="s3">:</span>
                <span class="s0">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertText</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOption</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># We need to imply &lt;/option&gt; if &lt;option&gt; is the current node.</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;option&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOptgroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;option&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;optgroup&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagSelect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-select-in-select&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagSelect</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">))</span>

        <span class="s0">def </span><span class="s1">startTagInput</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-input-in-select&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;select&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagSelect</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">token</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>

        <span class="s0">def </span><span class="s1">startTagScript</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-in-select&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagOption</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;option&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-in-select&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;option&quot;</span><span class="s6">}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagOptgroup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># &lt;/optgroup&gt; implicitly closes &lt;option&gt;</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;option&quot; </span><span class="s0">and</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">2</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;optgroup&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s5"># It also closes &lt;/optgroup&gt;</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;optgroup&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s5"># But nothing else</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-in-select&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;optgroup&quot;</span><span class="s6">}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagSelect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;select&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s0">while </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;select&quot;</span><span class="s3">:</span>
                    <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">resetInsertionMode</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-in-select&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;option&quot;</span><span class="s2">, </span><span class="s1">startTagOption</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;optgroup&quot;</span><span class="s2">, </span><span class="s1">startTagOptgroup</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">, </span><span class="s1">startTagSelect</span><span class="s2">),</span>
            <span class="s2">((</span><span class="s4">&quot;input&quot;</span><span class="s2">, </span><span class="s4">&quot;keygen&quot;</span><span class="s2">, </span><span class="s4">&quot;textarea&quot;</span><span class="s2">), </span><span class="s1">startTagInput</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;script&quot;</span><span class="s2">, </span><span class="s1">startTagScript</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;option&quot;</span><span class="s2">, </span><span class="s1">endTagOption</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;optgroup&quot;</span><span class="s2">, </span><span class="s1">endTagOptgroup</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">, </span><span class="s1">endTagSelect</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InSelectInTablePhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inSelect&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEOF</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inSelect&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-table-element-start-tag-in-select-in-table&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inSelect&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagTable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-table-element-end-tag-in-select-in-table&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">elementInScope</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s2">, </span><span class="s1">variant</span><span class="s3">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s4">&quot;select&quot;</span><span class="s2">))</span>
                <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inSelect&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">((</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">),</span>
             <span class="s1">startTagTable</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">((</span><span class="s4">&quot;caption&quot;</span><span class="s2">, </span><span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s4">&quot;tbody&quot;</span><span class="s2">, </span><span class="s4">&quot;tfoot&quot;</span><span class="s2">, </span><span class="s4">&quot;thead&quot;</span><span class="s2">, </span><span class="s4">&quot;tr&quot;</span><span class="s2">, </span><span class="s4">&quot;td&quot;</span><span class="s2">, </span><span class="s4">&quot;th&quot;</span><span class="s2">),</span>
             <span class="s1">endTagTable</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InForeignContentPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s1">breakoutElements </span><span class="s3">= </span><span class="s1">frozenset</span><span class="s2">(</span><span class="s6">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;big&quot;</span><span class="s2">, </span><span class="s4">&quot;blockquote&quot;</span><span class="s2">, </span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s4">&quot;br&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;center&quot;</span><span class="s2">, </span><span class="s4">&quot;code&quot;</span><span class="s2">, </span><span class="s4">&quot;dd&quot;</span><span class="s2">, </span><span class="s4">&quot;div&quot;</span><span class="s2">, </span><span class="s4">&quot;dl&quot;</span><span class="s2">, </span><span class="s4">&quot;dt&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;em&quot;</span><span class="s2">, </span><span class="s4">&quot;embed&quot;</span><span class="s2">, </span><span class="s4">&quot;h1&quot;</span><span class="s2">, </span><span class="s4">&quot;h2&quot;</span><span class="s2">, </span><span class="s4">&quot;h3&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;h4&quot;</span><span class="s2">, </span><span class="s4">&quot;h5&quot;</span><span class="s2">, </span><span class="s4">&quot;h6&quot;</span><span class="s2">, </span><span class="s4">&quot;head&quot;</span><span class="s2">, </span><span class="s4">&quot;hr&quot;</span><span class="s2">, </span><span class="s4">&quot;i&quot;</span><span class="s2">, </span><span class="s4">&quot;img&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;li&quot;</span><span class="s2">, </span><span class="s4">&quot;listing&quot;</span><span class="s2">, </span><span class="s4">&quot;menu&quot;</span><span class="s2">, </span><span class="s4">&quot;meta&quot;</span><span class="s2">, </span><span class="s4">&quot;nobr&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;ol&quot;</span><span class="s2">, </span><span class="s4">&quot;p&quot;</span><span class="s2">, </span><span class="s4">&quot;pre&quot;</span><span class="s2">, </span><span class="s4">&quot;ruby&quot;</span><span class="s2">, </span><span class="s4">&quot;s&quot;</span><span class="s2">, </span><span class="s4">&quot;small&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;span&quot;</span><span class="s2">, </span><span class="s4">&quot;strong&quot;</span><span class="s2">, </span><span class="s4">&quot;strike&quot;</span><span class="s2">, </span><span class="s4">&quot;sub&quot;</span><span class="s2">, </span><span class="s4">&quot;sup&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;table&quot;</span><span class="s2">, </span><span class="s4">&quot;tt&quot;</span><span class="s2">, </span><span class="s4">&quot;u&quot;</span><span class="s2">, </span><span class="s4">&quot;ul&quot;</span><span class="s2">, </span><span class="s4">&quot;var&quot;</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">adjustSVGTagNames</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">replacements </span><span class="s3">= </span><span class="s6">{</span><span class="s4">&quot;altglyph&quot;</span><span class="s3">: </span><span class="s4">&quot;altGlyph&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;altglyphdef&quot;</span><span class="s3">: </span><span class="s4">&quot;altGlyphDef&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;altglyphitem&quot;</span><span class="s3">: </span><span class="s4">&quot;altGlyphItem&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;animatecolor&quot;</span><span class="s3">: </span><span class="s4">&quot;animateColor&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;animatemotion&quot;</span><span class="s3">: </span><span class="s4">&quot;animateMotion&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;animatetransform&quot;</span><span class="s3">: </span><span class="s4">&quot;animateTransform&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;clippath&quot;</span><span class="s3">: </span><span class="s4">&quot;clipPath&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;feblend&quot;</span><span class="s3">: </span><span class="s4">&quot;feBlend&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fecolormatrix&quot;</span><span class="s3">: </span><span class="s4">&quot;feColorMatrix&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fecomponenttransfer&quot;</span><span class="s3">: </span><span class="s4">&quot;feComponentTransfer&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fecomposite&quot;</span><span class="s3">: </span><span class="s4">&quot;feComposite&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;feconvolvematrix&quot;</span><span class="s3">: </span><span class="s4">&quot;feConvolveMatrix&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fediffuselighting&quot;</span><span class="s3">: </span><span class="s4">&quot;feDiffuseLighting&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fedisplacementmap&quot;</span><span class="s3">: </span><span class="s4">&quot;feDisplacementMap&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fedistantlight&quot;</span><span class="s3">: </span><span class="s4">&quot;feDistantLight&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;feflood&quot;</span><span class="s3">: </span><span class="s4">&quot;feFlood&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fefunca&quot;</span><span class="s3">: </span><span class="s4">&quot;feFuncA&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fefuncb&quot;</span><span class="s3">: </span><span class="s4">&quot;feFuncB&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fefuncg&quot;</span><span class="s3">: </span><span class="s4">&quot;feFuncG&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fefuncr&quot;</span><span class="s3">: </span><span class="s4">&quot;feFuncR&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fegaussianblur&quot;</span><span class="s3">: </span><span class="s4">&quot;feGaussianBlur&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;feimage&quot;</span><span class="s3">: </span><span class="s4">&quot;feImage&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;femerge&quot;</span><span class="s3">: </span><span class="s4">&quot;feMerge&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;femergenode&quot;</span><span class="s3">: </span><span class="s4">&quot;feMergeNode&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;femorphology&quot;</span><span class="s3">: </span><span class="s4">&quot;feMorphology&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;feoffset&quot;</span><span class="s3">: </span><span class="s4">&quot;feOffset&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fepointlight&quot;</span><span class="s3">: </span><span class="s4">&quot;fePointLight&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fespecularlighting&quot;</span><span class="s3">: </span><span class="s4">&quot;feSpecularLighting&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fespotlight&quot;</span><span class="s3">: </span><span class="s4">&quot;feSpotLight&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;fetile&quot;</span><span class="s3">: </span><span class="s4">&quot;feTile&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;feturbulence&quot;</span><span class="s3">: </span><span class="s4">&quot;feTurbulence&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;foreignobject&quot;</span><span class="s3">: </span><span class="s4">&quot;foreignObject&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;glyphref&quot;</span><span class="s3">: </span><span class="s4">&quot;glyphRef&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;lineargradient&quot;</span><span class="s3">: </span><span class="s4">&quot;linearGradient&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;radialgradient&quot;</span><span class="s3">: </span><span class="s4">&quot;radialGradient&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;textpath&quot;</span><span class="s3">: </span><span class="s4">&quot;textPath&quot;</span><span class="s6">}</span>

            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s0">in </span><span class="s1">replacements</span><span class="s3">:</span>
                <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s1">replacements</span><span class="s6">[</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]]</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;\u0000&quot;</span><span class="s3">:</span>
                <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s4">&quot;\uFFFD&quot;</span>
            <span class="s0">elif </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s0">and</span>
                  <span class="s1">any</span><span class="s2">(</span><span class="s1">char </span><span class="s0">not in </span><span class="s1">spaceCharacters </span><span class="s0">for </span><span class="s1">char </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">))</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">framesetOK </span><span class="s3">= </span><span class="s0">False</span>
            <span class="s1">Phase</span><span class="s2">.</span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">currentNode </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">breakoutElements </span><span class="s0">or</span>
                <span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">] </span><span class="s3">== </span><span class="s4">&quot;font&quot; </span><span class="s0">and</span>
                 <span class="s1">set</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;data&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()) </span><span class="s3">&amp; </span><span class="s6">{</span><span class="s4">&quot;color&quot;</span><span class="s2">, </span><span class="s4">&quot;face&quot;</span><span class="s2">, </span><span class="s4">&quot;size&quot;</span><span class="s6">}</span><span class="s2">))</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-html-element-in-foreign-content&quot;</span><span class="s2">,</span>
                                       <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
                <span class="s0">while </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">namespace </span><span class="s3">!=</span>
                       <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">defaultNamespace </span><span class="s0">and</span>
                       <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">isHTMLIntegrationPoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">) </span><span class="s0">and</span>
                       <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">isMathMLTextIntegrationPoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">))</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s0">return </span><span class="s1">token</span>

            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">currentNode</span><span class="s2">.</span><span class="s1">namespace </span><span class="s3">== </span><span class="s1">namespaces</span><span class="s6">[</span><span class="s4">&quot;mathml&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">adjustMathMLAttributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">currentNode</span><span class="s2">.</span><span class="s1">namespace </span><span class="s3">== </span><span class="s1">namespaces</span><span class="s6">[</span><span class="s4">&quot;svg&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">adjustSVGTagNames</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">adjustSVGAttributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">adjustForeignAttributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;namespace&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s1">currentNode</span><span class="s2">.</span><span class="s1">namespace</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosing&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                    <span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;selfClosingAcknowledged&quot;</span><span class="s6">] </span><span class="s3">= </span><span class="s0">True</span>

        <span class="s0">def </span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">nodeIndex </span><span class="s3">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">) </span><span class="s3">- </span><span class="s7">1</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span>
            <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">asciiUpper2Lower</span><span class="s2">) </span><span class="s3">!= </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag&quot;</span><span class="s2">, </span><span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

            <span class="s0">while True</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">asciiUpper2Lower</span><span class="s2">) </span><span class="s3">== </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]</span><span class="s3">:</span>
                    <span class="s5"># XXX this isn't in the spec but it seems necessary</span>
                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inTableText&quot;</span><span class="s6">]</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">flushCharacters</span><span class="s2">()</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">originalPhase</span>
                    <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">() </span><span class="s3">!= </span><span class="s1">node</span><span class="s3">:</span>
                        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span>
                    <span class="s1">new_token </span><span class="s3">= </span><span class="s0">None</span>
                    <span class="s0">break</span>
                <span class="s1">nodeIndex </span><span class="s3">-= </span><span class="s7">1</span>

                <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s1">nodeIndex</span><span class="s6">]</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">namespace </span><span class="s3">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">defaultNamespace</span><span class="s3">:</span>
                    <span class="s0">continue</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s1">new_token </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
                    <span class="s0">break</span>
            <span class="s0">return </span><span class="s1">new_token</span>

    <span class="s0">class </span><span class="s1">AfterBodyPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Stop parsing</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># This is needed because data is to be appended to the &lt;html&gt; element</span>
            <span class="s5"># here and not to whatever is currently open.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertComment</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s7">0</span><span class="s6">]</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-char-after-body&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-after-body&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">endTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-after-body-innerhtml&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;afterAfterBody&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-after-body&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">startTagHtml</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span><span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">endTagHtml</span><span class="s2">)</span><span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">InFramesetPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#in-frameset</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;eof-in-frameset&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-char-in-frameset&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagFrameset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagFrame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertElement</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">startTagNoframes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-in-frameset&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagFrameset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;html&quot;</span><span class="s3">:</span>
                <span class="s5"># innerHTML case</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-frameset-in-frameset-innerhtml&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">innerHTML </span><span class="s0">and</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">openElements</span><span class="s6">[</span><span class="s3">-</span><span class="s7">1</span><span class="s6">]</span><span class="s2">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;frameset&quot;</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s5"># If we're not in innerHTML mode and the current node is not a</span>
                <span class="s5"># &quot;frameset&quot; element (anymore) then switch.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;afterFrameset&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-in-frameset&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;frameset&quot;</span><span class="s2">, </span><span class="s1">startTagFrameset</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;frame&quot;</span><span class="s2">, </span><span class="s1">startTagFrame</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;noframes&quot;</span><span class="s2">, </span><span class="s1">startTagNoframes</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;frameset&quot;</span><span class="s2">, </span><span class="s1">endTagFrameset</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">AfterFramesetPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># http://www.whatwg.org/specs/web-apps/current-work/#after3</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s5"># Stop parsing</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-char-after-frameset&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagNoframes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-start-tag-after-frameset&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">endTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;afterAfterFrameset&quot;</span><span class="s6">]</span>

        <span class="s0">def </span><span class="s1">endTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;unexpected-end-tag-after-frameset&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">Phase</span><span class="s2">.</span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;noframes&quot;</span><span class="s2">, </span><span class="s1">startTagNoframes</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

        <span class="s1">endTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">endTagHtml</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">endTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">endTagOther</span>

    <span class="s0">class </span><span class="s1">AfterAfterBodyPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertComment</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">document</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-eof-but-got-char&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-eof-but-got-start-tag&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s0">def </span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-eof-but-got-end-tag&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phase </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span>
            <span class="s0">return </span><span class="s1">token</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">startTagHtml</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

    <span class="s0">class </span><span class="s1">AfterAfterFramesetPhase</span><span class="s2">(</span><span class="s1">Phase</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">tuple</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">processEOF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">pass</span>

        <span class="s0">def </span><span class="s1">processComment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">insertComment</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">document</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processSpaceCharacters</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processCharacters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-eof-but-got-char&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagHtml</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inBody&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagNoFrames</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">phases</span><span class="s6">[</span><span class="s4">&quot;inHead&quot;</span><span class="s6">]</span><span class="s2">.</span><span class="s1">processStartTag</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">startTagOther</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-eof-but-got-start-tag&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">processEndTag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">token</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parseError</span><span class="s2">(</span><span class="s4">&quot;expected-eof-but-got-end-tag&quot;</span><span class="s2">,</span>
                                   <span class="s6">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">token</span><span class="s6">[</span><span class="s4">&quot;name&quot;</span><span class="s6">]}</span><span class="s2">)</span>

        <span class="s1">startTagHandler </span><span class="s3">= </span><span class="s1">_utils</span><span class="s2">.</span><span class="s1">MethodDispatcher</span><span class="s2">(</span><span class="s6">[</span>
            <span class="s2">(</span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s1">startTagHtml</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;noframes&quot;</span><span class="s2">, </span><span class="s1">startTagNoFrames</span><span class="s2">)</span>
        <span class="s6">]</span><span class="s2">)</span>
        <span class="s1">startTagHandler</span><span class="s2">.</span><span class="s1">default </span><span class="s3">= </span><span class="s1">startTagOther</span>

    <span class="s5"># pylint:enable=unused-argument</span>

    <span class="s0">return </span><span class="s6">{</span>
        <span class="s4">&quot;initial&quot;</span><span class="s3">: </span><span class="s1">InitialPhase</span><span class="s2">,</span>
        <span class="s4">&quot;beforeHtml&quot;</span><span class="s3">: </span><span class="s1">BeforeHtmlPhase</span><span class="s2">,</span>
        <span class="s4">&quot;beforeHead&quot;</span><span class="s3">: </span><span class="s1">BeforeHeadPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inHead&quot;</span><span class="s3">: </span><span class="s1">InHeadPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inHeadNoscript&quot;</span><span class="s3">: </span><span class="s1">InHeadNoscriptPhase</span><span class="s2">,</span>
        <span class="s4">&quot;afterHead&quot;</span><span class="s3">: </span><span class="s1">AfterHeadPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inBody&quot;</span><span class="s3">: </span><span class="s1">InBodyPhase</span><span class="s2">,</span>
        <span class="s4">&quot;text&quot;</span><span class="s3">: </span><span class="s1">TextPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inTable&quot;</span><span class="s3">: </span><span class="s1">InTablePhase</span><span class="s2">,</span>
        <span class="s4">&quot;inTableText&quot;</span><span class="s3">: </span><span class="s1">InTableTextPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inCaption&quot;</span><span class="s3">: </span><span class="s1">InCaptionPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inColumnGroup&quot;</span><span class="s3">: </span><span class="s1">InColumnGroupPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inTableBody&quot;</span><span class="s3">: </span><span class="s1">InTableBodyPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inRow&quot;</span><span class="s3">: </span><span class="s1">InRowPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inCell&quot;</span><span class="s3">: </span><span class="s1">InCellPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inSelect&quot;</span><span class="s3">: </span><span class="s1">InSelectPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inSelectInTable&quot;</span><span class="s3">: </span><span class="s1">InSelectInTablePhase</span><span class="s2">,</span>
        <span class="s4">&quot;inForeignContent&quot;</span><span class="s3">: </span><span class="s1">InForeignContentPhase</span><span class="s2">,</span>
        <span class="s4">&quot;afterBody&quot;</span><span class="s3">: </span><span class="s1">AfterBodyPhase</span><span class="s2">,</span>
        <span class="s4">&quot;inFrameset&quot;</span><span class="s3">: </span><span class="s1">InFramesetPhase</span><span class="s2">,</span>
        <span class="s4">&quot;afterFrameset&quot;</span><span class="s3">: </span><span class="s1">AfterFramesetPhase</span><span class="s2">,</span>
        <span class="s4">&quot;afterAfterBody&quot;</span><span class="s3">: </span><span class="s1">AfterAfterBodyPhase</span><span class="s2">,</span>
        <span class="s4">&quot;afterAfterFrameset&quot;</span><span class="s3">: </span><span class="s1">AfterAfterFramesetPhase</span><span class="s2">,</span>
        <span class="s5"># XXX after after frameset</span>
    <span class="s6">}</span>


<span class="s0">def </span><span class="s1">adjust_attributes</span><span class="s2">(</span><span class="s1">token</span><span class="s2">, </span><span class="s1">replacements</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s1">needs_adjustment </span><span class="s3">= </span><span class="s1">viewkeys</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">'data'</span><span class="s6">]</span><span class="s2">) </span><span class="s3">&amp; </span><span class="s1">viewkeys</span><span class="s2">(</span><span class="s1">replacements</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">needs_adjustment</span><span class="s3">:</span>
        <span class="s1">token</span><span class="s6">[</span><span class="s4">'data'</span><span class="s6">] </span><span class="s3">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">token</span><span class="s6">[</span><span class="s4">'data'</span><span class="s6">]</span><span class="s2">)((</span><span class="s1">replacements</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">v</span><span class="s2">)</span>
                                            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">token</span><span class="s6">[</span><span class="s4">'data'</span><span class="s6">]</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">impliedTagToken</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">type</span><span class="s3">=</span><span class="s4">&quot;EndTag&quot;</span><span class="s2">, </span><span class="s1">attributes</span><span class="s3">=</span><span class="s0">None</span><span class="s2">,</span>
                    <span class="s1">selfClosing</span><span class="s3">=</span><span class="s0">False</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s0">if </span><span class="s1">attributes </span><span class="s0">is None</span><span class="s3">:</span>
        <span class="s1">attributes </span><span class="s3">= </span><span class="s6">{}</span>
    <span class="s0">return </span><span class="s6">{</span><span class="s4">&quot;type&quot;</span><span class="s3">: </span><span class="s1">tokenTypes</span><span class="s6">[</span><span class="s1">type</span><span class="s6">]</span><span class="s2">, </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">name</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s3">: </span><span class="s1">attributes</span><span class="s2">,</span>
            <span class="s4">&quot;selfClosing&quot;</span><span class="s3">: </span><span class="s1">selfClosing</span><span class="s6">}</span>


<span class="s0">class </span><span class="s1">ParseError</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;Error in parsed document&quot;&quot;&quot;</span>
    <span class="s0">pass</span>
</pre>
</body>
</html>