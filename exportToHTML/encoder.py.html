<html>
<head>
<title>encoder.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #b877db; font-style: italic;}
.s1 { color: #b6c4f2;}
.s2 { color: #b4c2f0;}
.s3 { color: #baacff;}
.s4 { color: #ff9668;}
.s5 { color: #475f76;}
.s6 { color: #64d1a9;}
.s7 { color: #7fdaff;}
</style>
</head>
<body bgcolor="#1c1e26">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
encoder.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">decimal </span><span class="s0">import </span><span class="s1">Decimal</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">toml</span><span class="s2">.</span><span class="s1">decoder </span><span class="s0">import </span><span class="s1">InlineTableDict</span>

<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s3">&gt;= </span><span class="s2">(</span><span class="s4">3</span><span class="s2">,)</span><span class="s3">:</span>
    <span class="s1">unicode </span><span class="s3">= </span><span class="s1">str</span>


<span class="s0">def </span><span class="s1">dump</span><span class="s2">(</span><span class="s1">o</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s1">encoder</span><span class="s3">=</span><span class="s0">None</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;Writes out dict as toml to a file 
 
    Args: 
        o: Object to dump into toml 
        f: File descriptor where the toml should be stored 
        encoder: The ``TomlEncoder`` to use for constructing the output string 
 
    Returns: 
        String containing the toml corresponding to dictionary 
 
    Raises: 
        TypeError: When anything other than file descriptor is passed 
    &quot;&quot;&quot;</span>

    <span class="s0">if not </span><span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s3">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s6">&quot;You can only dump an object to a file descriptor&quot;</span><span class="s2">)</span>
    <span class="s1">d </span><span class="s3">= </span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">o</span><span class="s2">, </span><span class="s1">encoder</span><span class="s3">=</span><span class="s1">encoder</span><span class="s2">)</span>
    <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">d</span>


<span class="s0">def </span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">o</span><span class="s2">, </span><span class="s1">encoder</span><span class="s3">=</span><span class="s0">None</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot;Stringifies input dict as toml 
 
    Args: 
        o: Object to dump into toml 
        encoder: The ``TomlEncoder`` to use for constructing the output string 
 
    Returns: 
        String containing the toml corresponding to dict 
 
    Examples: 
        ```python 
        &gt;&gt;&gt; import toml 
        &gt;&gt;&gt; output = { 
        ... 'a': &quot;I'm a string&quot;, 
        ... 'b': [&quot;I'm&quot;, &quot;a&quot;, &quot;list&quot;], 
        ... 'c': 2400 
        ... } 
        &gt;&gt;&gt; toml.dumps(output) 
        'a = &quot;I\'m a string&quot;\nb = [ &quot;I\'m&quot;, &quot;a&quot;, &quot;list&quot;,]\nc = 2400\n' 
        ``` 
    &quot;&quot;&quot;</span>

    <span class="s1">retval </span><span class="s3">= </span><span class="s6">&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">encoder </span><span class="s0">is None</span><span class="s3">:</span>
        <span class="s1">encoder </span><span class="s3">= </span><span class="s1">TomlEncoder</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">)</span>
    <span class="s1">addtoretval</span><span class="s2">, </span><span class="s1">sections </span><span class="s3">= </span><span class="s1">encoder</span><span class="s2">.</span><span class="s1">dump_sections</span><span class="s2">(</span><span class="s1">o</span><span class="s2">, </span><span class="s6">&quot;&quot;</span><span class="s2">)</span>
    <span class="s1">retval </span><span class="s3">+= </span><span class="s1">addtoretval</span>
    <span class="s1">outer_objs </span><span class="s3">= </span><span class="s7">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">o</span><span class="s2">)</span><span class="s7">]</span>
    <span class="s0">while </span><span class="s1">sections</span><span class="s3">:</span>
        <span class="s1">section_ids </span><span class="s3">= </span><span class="s7">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">section</span><span class="s2">) </span><span class="s0">for </span><span class="s1">section </span><span class="s0">in </span><span class="s1">sections</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()</span><span class="s7">]</span>
        <span class="s0">for </span><span class="s1">outer_obj </span><span class="s0">in </span><span class="s1">outer_objs</span><span class="s3">:</span>
            <span class="s0">if </span><span class="s1">outer_obj </span><span class="s0">in </span><span class="s1">section_ids</span><span class="s3">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;Circular reference detected&quot;</span><span class="s2">)</span>
        <span class="s1">outer_objs </span><span class="s3">+= </span><span class="s1">section_ids</span>
        <span class="s1">newsections </span><span class="s3">= </span><span class="s1">encoder</span><span class="s2">.</span><span class="s1">get_empty_table</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">section </span><span class="s0">in </span><span class="s1">sections</span><span class="s3">:</span>
            <span class="s1">addtoretval</span><span class="s2">, </span><span class="s1">addtosections </span><span class="s3">= </span><span class="s1">encoder</span><span class="s2">.</span><span class="s1">dump_sections</span><span class="s2">(</span>
                <span class="s1">sections</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s2">, </span><span class="s1">section</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">addtoretval </span><span class="s0">or </span><span class="s2">(</span><span class="s0">not </span><span class="s1">addtoretval </span><span class="s0">and not </span><span class="s1">addtosections</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">retval </span><span class="s0">and </span><span class="s1">retval</span><span class="s7">[</span><span class="s3">-</span><span class="s4">2</span><span class="s3">:</span><span class="s7">] </span><span class="s3">!= </span><span class="s6">&quot;\n\n&quot;</span><span class="s3">:</span>
                    <span class="s1">retval </span><span class="s3">+= </span><span class="s6">&quot;\n&quot;</span>
                <span class="s1">retval </span><span class="s3">+= </span><span class="s6">&quot;[&quot; </span><span class="s3">+ </span><span class="s1">section </span><span class="s3">+ </span><span class="s6">&quot;]\n&quot;</span>
                <span class="s0">if </span><span class="s1">addtoretval</span><span class="s3">:</span>
                    <span class="s1">retval </span><span class="s3">+= </span><span class="s1">addtoretval</span>
            <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">addtosections</span><span class="s3">:</span>
                <span class="s1">newsections</span><span class="s7">[</span><span class="s1">section </span><span class="s3">+ </span><span class="s6">&quot;.&quot; </span><span class="s3">+ </span><span class="s1">s</span><span class="s7">] </span><span class="s3">= </span><span class="s1">addtosections</span><span class="s7">[</span><span class="s1">s</span><span class="s7">]</span>
        <span class="s1">sections </span><span class="s3">= </span><span class="s1">newsections</span>
    <span class="s0">return </span><span class="s1">retval</span>


<span class="s0">def </span><span class="s1">_dump_str</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s3">&lt; </span><span class="s2">(</span><span class="s4">3</span><span class="s2">,) </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s6">'decode'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s6">'utf-8'</span><span class="s2">)</span>
    <span class="s1">v </span><span class="s3">= </span><span class="s6">&quot;%r&quot; </span><span class="s3">% </span><span class="s1">v</span>
    <span class="s0">if </span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">] </span><span class="s3">== </span><span class="s6">'u'</span><span class="s3">:</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s7">[</span><span class="s4">1</span><span class="s3">:</span><span class="s7">]</span>
    <span class="s1">singlequote </span><span class="s3">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s6">&quot;'&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">singlequote </span><span class="s0">or </span><span class="s1">v</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s6">'&quot;'</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s7">[</span><span class="s4">1</span><span class="s3">:-</span><span class="s4">1</span><span class="s7">]</span>
    <span class="s0">if </span><span class="s1">singlequote</span><span class="s3">:</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">&quot;\\'&quot;</span><span class="s2">, </span><span class="s6">&quot;'&quot;</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">'&quot;'</span><span class="s2">, </span><span class="s6">'\\&quot;'</span><span class="s2">)</span>
    <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">&quot;\\x&quot;</span><span class="s2">)</span>
    <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s3">&gt; </span><span class="s4">1</span><span class="s3">:</span>
        <span class="s1">i </span><span class="s3">= -</span><span class="s4">1</span>
        <span class="s0">if not </span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">]</span><span class="s3">:</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s7">[</span><span class="s4">1</span><span class="s3">:</span><span class="s7">]</span>
        <span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">] </span><span class="s3">= </span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">]</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">&quot;\\\\&quot;</span><span class="s2">, </span><span class="s6">&quot;\\&quot;</span><span class="s2">)</span>
        <span class="s5"># No, I don't know why != works and == breaks</span>
        <span class="s1">joinx </span><span class="s3">= </span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">][</span><span class="s1">i</span><span class="s7">] </span><span class="s3">!= </span><span class="s6">&quot;\\&quot;</span>
        <span class="s0">while </span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">][</span><span class="s3">:</span><span class="s1">i</span><span class="s7">] </span><span class="s0">and </span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">][</span><span class="s1">i</span><span class="s7">] </span><span class="s3">== </span><span class="s6">&quot;\\&quot;</span><span class="s3">:</span>
            <span class="s1">joinx </span><span class="s3">= </span><span class="s0">not </span><span class="s1">joinx</span>
            <span class="s1">i </span><span class="s3">-= </span><span class="s4">1</span>
        <span class="s0">if </span><span class="s1">joinx</span><span class="s3">:</span>
            <span class="s1">joiner </span><span class="s3">= </span><span class="s6">&quot;x&quot;</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s1">joiner </span><span class="s3">= </span><span class="s6">&quot;u00&quot;</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s7">[</span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">] </span><span class="s3">+ </span><span class="s1">joiner </span><span class="s3">+ </span><span class="s1">v</span><span class="s7">[</span><span class="s4">1</span><span class="s7">]] </span><span class="s3">+ </span><span class="s1">v</span><span class="s7">[</span><span class="s4">2</span><span class="s3">:</span><span class="s7">]</span>
    <span class="s0">return </span><span class="s1">unicode</span><span class="s2">(</span><span class="s6">'&quot;' </span><span class="s3">+ </span><span class="s1">v</span><span class="s7">[</span><span class="s4">0</span><span class="s7">] </span><span class="s3">+ </span><span class="s6">'&quot;'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_dump_float</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s0">return </span><span class="s6">&quot;{}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">v</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">&quot;e+0&quot;</span><span class="s2">, </span><span class="s6">&quot;e+&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">&quot;e-0&quot;</span><span class="s2">, </span><span class="s6">&quot;e-&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_dump_time</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
    <span class="s1">utcoffset </span><span class="s3">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">utcoffset</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">utcoffset </span><span class="s0">is None</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">v</span><span class="s2">.</span><span class="s1">isoformat</span><span class="s2">()</span>
    <span class="s5"># The TOML norm specifies that it's local time thus we drop the offset</span>
    <span class="s0">return </span><span class="s1">v</span><span class="s2">.</span><span class="s1">isoformat</span><span class="s2">()</span><span class="s7">[</span><span class="s3">:-</span><span class="s4">6</span><span class="s7">]</span>


<span class="s0">class </span><span class="s1">TomlEncoder</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span><span class="s3">:</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_dict</span><span class="s3">=</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">preserve</span><span class="s3">=</span><span class="s0">False</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_dict </span><span class="s3">= </span><span class="s1">_dict</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">preserve </span><span class="s3">= </span><span class="s1">preserve</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs </span><span class="s3">= </span><span class="s7">{</span>
            <span class="s1">str</span><span class="s3">: </span><span class="s1">_dump_str</span><span class="s2">,</span>
            <span class="s1">unicode</span><span class="s3">: </span><span class="s1">_dump_str</span><span class="s2">,</span>
            <span class="s1">list</span><span class="s3">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_list</span><span class="s2">,</span>
            <span class="s1">bool</span><span class="s3">: </span><span class="s0">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">unicode</span><span class="s2">(</span><span class="s1">v</span><span class="s2">).</span><span class="s1">lower</span><span class="s2">(),</span>
            <span class="s1">int</span><span class="s3">: </span><span class="s0">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">v</span><span class="s2">,</span>
            <span class="s1">float</span><span class="s3">: </span><span class="s1">_dump_float</span><span class="s2">,</span>
            <span class="s1">Decimal</span><span class="s3">: </span><span class="s1">_dump_float</span><span class="s2">,</span>
            <span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s3">: </span><span class="s0">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">v</span><span class="s2">.</span><span class="s1">isoformat</span><span class="s2">().</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">'+00:00'</span><span class="s2">, </span><span class="s6">'Z'</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">.</span><span class="s1">time</span><span class="s3">: </span><span class="s1">_dump_time</span><span class="s2">,</span>
            <span class="s1">datetime</span><span class="s2">.</span><span class="s1">date</span><span class="s3">: </span><span class="s0">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">v</span><span class="s2">.</span><span class="s1">isoformat</span><span class="s2">()</span>
        <span class="s7">}</span>

    <span class="s0">def </span><span class="s1">get_empty_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dict</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">dump_list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">retval </span><span class="s3">= </span><span class="s6">&quot;[&quot;</span>
        <span class="s0">for </span><span class="s1">u </span><span class="s0">in </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s1">retval </span><span class="s3">+= </span><span class="s6">&quot; &quot; </span><span class="s3">+ </span><span class="s1">unicode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_value</span><span class="s2">(</span><span class="s1">u</span><span class="s2">)) </span><span class="s3">+ </span><span class="s6">&quot;,&quot;</span>
        <span class="s1">retval </span><span class="s3">+= </span><span class="s6">&quot;]&quot;</span>
        <span class="s0">return </span><span class="s1">retval</span>

    <span class="s0">def </span><span class="s1">dump_inline_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">section</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Preserve inline table in its compact syntax instead of expanding 
        into subsection. 
 
        https://github.com/toml-lang/toml#user-content-inline-table 
        &quot;&quot;&quot;</span>
        <span class="s1">retval </span><span class="s3">= </span><span class="s6">&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">section</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">val_list </span><span class="s3">= </span><span class="s7">[]</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">section</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span><span class="s3">:</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_inline_table</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
                <span class="s1">val_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">k </span><span class="s3">+ </span><span class="s6">&quot; = &quot; </span><span class="s3">+ </span><span class="s1">val</span><span class="s2">)</span>
            <span class="s1">retval </span><span class="s3">+= </span><span class="s6">&quot;{ &quot; </span><span class="s3">+ </span><span class="s6">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">val_list</span><span class="s2">) </span><span class="s3">+ </span><span class="s6">&quot; }\n&quot;</span>
            <span class="s0">return </span><span class="s1">retval</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">unicode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_value</span><span class="s2">(</span><span class="s1">section</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">dump_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s5"># Lookup function corresponding to v's type</span>
        <span class="s1">dump_fn </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">v</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">dump_fn </span><span class="s0">is None and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s6">'__iter__'</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s1">dump_fn </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">list</span><span class="s7">]</span>
        <span class="s5"># Evaluate function (if it exists) else return v</span>
        <span class="s0">return </span><span class="s1">dump_fn</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s0">if </span><span class="s1">dump_fn </span><span class="s0">is not None else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">str</span><span class="s7">]</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">dump_sections</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">o</span><span class="s2">, </span><span class="s1">sup</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">retstr </span><span class="s3">= </span><span class="s6">&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">sup </span><span class="s3">!= </span><span class="s6">&quot;&quot; </span><span class="s0">and </span><span class="s1">sup</span><span class="s7">[</span><span class="s3">-</span><span class="s4">1</span><span class="s7">] </span><span class="s3">!= </span><span class="s6">&quot;.&quot;</span><span class="s3">:</span>
            <span class="s1">sup </span><span class="s3">+= </span><span class="s6">'.'</span>
        <span class="s1">retdict </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dict</span><span class="s2">()</span>
        <span class="s1">arraystr </span><span class="s3">= </span><span class="s6">&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">section </span><span class="s0">in </span><span class="s1">o</span><span class="s3">:</span>
            <span class="s1">section </span><span class="s3">= </span><span class="s1">unicode</span><span class="s2">(</span><span class="s1">section</span><span class="s2">)</span>
            <span class="s1">qsection </span><span class="s3">= </span><span class="s1">section</span>
            <span class="s0">if not </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s6">r'^[A-Za-z0-9_-]+$'</span><span class="s2">, </span><span class="s1">section</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">qsection </span><span class="s3">= </span><span class="s1">_dump_str</span><span class="s2">(</span><span class="s1">section</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">arrayoftables </span><span class="s3">= </span><span class="s0">False</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s3">:</span>
                        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">)</span><span class="s3">:</span>
                            <span class="s1">arrayoftables </span><span class="s3">= </span><span class="s0">True</span>
                <span class="s0">if </span><span class="s1">arrayoftables</span><span class="s3">:</span>
                    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s3">:</span>
                        <span class="s1">arraytabstr </span><span class="s3">= </span><span class="s6">&quot;\n&quot;</span>
                        <span class="s1">arraystr </span><span class="s3">+= </span><span class="s6">&quot;[[&quot; </span><span class="s3">+ </span><span class="s1">sup </span><span class="s3">+ </span><span class="s1">qsection </span><span class="s3">+ </span><span class="s6">&quot;]]\n&quot;</span>
                        <span class="s1">s</span><span class="s2">, </span><span class="s1">d </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_sections</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">sup </span><span class="s3">+ </span><span class="s1">qsection</span><span class="s2">)</span>
                        <span class="s0">if </span><span class="s1">s</span><span class="s3">:</span>
                            <span class="s0">if </span><span class="s1">s</span><span class="s7">[</span><span class="s4">0</span><span class="s7">] </span><span class="s3">== </span><span class="s6">&quot;[&quot;</span><span class="s3">:</span>
                                <span class="s1">arraytabstr </span><span class="s3">+= </span><span class="s1">s</span>
                            <span class="s0">else</span><span class="s3">:</span>
                                <span class="s1">arraystr </span><span class="s3">+= </span><span class="s1">s</span>
                        <span class="s0">while </span><span class="s1">d</span><span class="s3">:</span>
                            <span class="s1">newd </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dict</span><span class="s2">()</span>
                            <span class="s0">for </span><span class="s1">dsec </span><span class="s0">in </span><span class="s1">d</span><span class="s3">:</span>
                                <span class="s1">s1</span><span class="s2">, </span><span class="s1">d1 </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_sections</span><span class="s2">(</span><span class="s1">d</span><span class="s7">[</span><span class="s1">dsec</span><span class="s7">]</span><span class="s2">, </span><span class="s1">sup </span><span class="s3">+</span>
                                                            <span class="s1">qsection </span><span class="s3">+ </span><span class="s6">&quot;.&quot; </span><span class="s3">+</span>
                                                            <span class="s1">dsec</span><span class="s2">)</span>
                                <span class="s0">if </span><span class="s1">s1</span><span class="s3">:</span>
                                    <span class="s1">arraytabstr </span><span class="s3">+= </span><span class="s2">(</span><span class="s6">&quot;[&quot; </span><span class="s3">+ </span><span class="s1">sup </span><span class="s3">+ </span><span class="s1">qsection </span><span class="s3">+</span>
                                                    <span class="s6">&quot;.&quot; </span><span class="s3">+ </span><span class="s1">dsec </span><span class="s3">+ </span><span class="s6">&quot;]\n&quot;</span><span class="s2">)</span>
                                    <span class="s1">arraytabstr </span><span class="s3">+= </span><span class="s1">s1</span>
                                <span class="s0">for </span><span class="s1">s1 </span><span class="s0">in </span><span class="s1">d1</span><span class="s3">:</span>
                                    <span class="s1">newd</span><span class="s7">[</span><span class="s1">dsec </span><span class="s3">+ </span><span class="s6">&quot;.&quot; </span><span class="s3">+ </span><span class="s1">s1</span><span class="s7">] </span><span class="s3">= </span><span class="s1">d1</span><span class="s7">[</span><span class="s1">s1</span><span class="s7">]</span>
                            <span class="s1">d </span><span class="s3">= </span><span class="s1">newd</span>
                        <span class="s1">arraystr </span><span class="s3">+= </span><span class="s1">arraytabstr</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s0">if </span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">] </span><span class="s0">is not None</span><span class="s3">:</span>
                        <span class="s1">retstr </span><span class="s3">+= </span><span class="s2">(</span><span class="s1">qsection </span><span class="s3">+ </span><span class="s6">&quot; = &quot; </span><span class="s3">+</span>
                                   <span class="s1">unicode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_value</span><span class="s2">(</span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s2">)) </span><span class="s3">+ </span><span class="s6">'\n'</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">preserve </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s2">, </span><span class="s1">InlineTableDict</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">retstr </span><span class="s3">+= </span><span class="s2">(</span><span class="s1">qsection </span><span class="s3">+ </span><span class="s6">&quot; = &quot; </span><span class="s3">+</span>
                           <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_inline_table</span><span class="s2">(</span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s1">retdict</span><span class="s7">[</span><span class="s1">qsection</span><span class="s7">] </span><span class="s3">= </span><span class="s1">o</span><span class="s7">[</span><span class="s1">section</span><span class="s7">]</span>
        <span class="s1">retstr </span><span class="s3">+= </span><span class="s1">arraystr</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">retstr</span><span class="s2">, </span><span class="s1">retdict</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TomlPreserveInlineDictEncoder</span><span class="s2">(</span><span class="s1">TomlEncoder</span><span class="s2">)</span><span class="s3">:</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_dict</span><span class="s3">=</span><span class="s1">dict</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">TomlPreserveInlineDictEncoder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">_dict</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TomlArraySeparatorEncoder</span><span class="s2">(</span><span class="s1">TomlEncoder</span><span class="s2">)</span><span class="s3">:</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_dict</span><span class="s3">=</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">preserve</span><span class="s3">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">separator</span><span class="s3">=</span><span class="s6">&quot;,&quot;</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">TomlArraySeparatorEncoder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">_dict</span><span class="s2">, </span><span class="s1">preserve</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">separator</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() </span><span class="s3">== </span><span class="s6">&quot;&quot;</span><span class="s3">:</span>
            <span class="s1">separator </span><span class="s3">= </span><span class="s6">&quot;,&quot; </span><span class="s3">+ </span><span class="s1">separator</span>
        <span class="s0">elif </span><span class="s1">separator</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s6">' \t\n\r,'</span><span class="s2">)</span><span class="s3">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;Invalid separator for arrays&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">separator </span><span class="s3">= </span><span class="s1">separator</span>

    <span class="s0">def </span><span class="s1">dump_list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s1">t </span><span class="s3">= </span><span class="s7">[]</span>
        <span class="s1">retval </span><span class="s3">= </span><span class="s6">&quot;[&quot;</span>
        <span class="s0">for </span><span class="s1">u </span><span class="s0">in </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_value</span><span class="s2">(</span><span class="s1">u</span><span class="s2">))</span>
        <span class="s0">while </span><span class="s1">t </span><span class="s3">!= </span><span class="s7">[]</span><span class="s3">:</span>
            <span class="s1">s </span><span class="s3">= </span><span class="s7">[]</span>
            <span class="s0">for </span><span class="s1">u </span><span class="s0">in </span><span class="s1">t</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span><span class="s3">:</span>
                    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">u</span><span class="s3">:</span>
                        <span class="s1">s</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">r</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s1">retval </span><span class="s3">+= </span><span class="s6">&quot; &quot; </span><span class="s3">+ </span><span class="s1">unicode</span><span class="s2">(</span><span class="s1">u</span><span class="s2">) </span><span class="s3">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">separator</span>
            <span class="s1">t </span><span class="s3">= </span><span class="s1">s</span>
        <span class="s1">retval </span><span class="s3">+= </span><span class="s6">&quot;]&quot;</span>
        <span class="s0">return </span><span class="s1">retval</span>


<span class="s0">class </span><span class="s1">TomlNumpyEncoder</span><span class="s2">(</span><span class="s1">TomlEncoder</span><span class="s2">)</span><span class="s3">:</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_dict</span><span class="s3">=</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">preserve</span><span class="s3">=</span><span class="s0">False</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">TomlNumpyEncoder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">_dict</span><span class="s2">, </span><span class="s1">preserve</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s7">] </span><span class="s3">= </span><span class="s1">_dump_float</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s7">] </span><span class="s3">= </span><span class="s1">_dump_float</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s7">] </span><span class="s3">= </span><span class="s1">_dump_float</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s7">] </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dump_int</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s7">] </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dump_int</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s7">] </span><span class="s3">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dump_int</span>

    <span class="s0">def </span><span class="s1">_dump_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s6">&quot;{}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">v</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TomlPreserveCommentEncoder</span><span class="s2">(</span><span class="s1">TomlEncoder</span><span class="s2">)</span><span class="s3">:</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_dict</span><span class="s3">=</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">preserve</span><span class="s3">=</span><span class="s0">False</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">toml</span><span class="s2">.</span><span class="s1">decoder </span><span class="s0">import </span><span class="s1">CommentValue</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">TomlPreserveCommentEncoder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">_dict</span><span class="s2">, </span><span class="s1">preserve</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dump_funcs</span><span class="s7">[</span><span class="s1">CommentValue</span><span class="s7">] </span><span class="s3">= </span><span class="s0">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">v</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dump_value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TomlPathlibEncoder</span><span class="s2">(</span><span class="s1">TomlEncoder</span><span class="s2">)</span><span class="s3">:</span>

    <span class="s0">def </span><span class="s1">_dump_pathlib_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">_dump_str</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">v</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">dump_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span><span class="s3">:</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">) </span><span class="s3">&lt;= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s3">:</span>
            <span class="s0">import </span><span class="s1">pathlib</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">pathlib</span><span class="s2">.</span><span class="s1">PurePath</span><span class="s2">)</span><span class="s3">:</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">TomlPathlibEncoder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">dump_value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
</pre>
</body>
</html>